<!doctype html><html><head><title>从 netctl 切换到 systemd-networkd</title><meta charset=utf-8><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="A blog maintained by an interesting programmer."><meta name=keywords content="Technology,Code,Program,Linux,"><meta name=author content="Xuanwo"><meta property="og:title" content="从 netctl 切换到 systemd-networkd"><meta property="og:description" content="A blog maintained by an interesting programmer."><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="https://xuanwo.io/2019/06/13/switch-to-systemd-networkd/"><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=https://xuanwo.io/css/main.min.a285da0837b674a21742d9d9056c807cf8074d0e7b0cd2e85d30ed1ddf2acddd.css integrity="sha256-ooXaCDe2dKIXQtnZBWyAfPgHTQ57DNLoXTDtHd8qzd0="><script data-ad-client=ca-pub-8380875817494486 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><link href=http://gmpg.org/xfn/11 rel=profile><meta name=generator content="Hugo 0.61.0"></head><body><nav class=nav><div class=nav-container><div class=brand><a href=https://xuanwo.io>Xuanwo's Blog</a></div><div class=links><a class=main-nav-link href=/about/>关于我</a>
<a class=main-nav-link href=/posts/>文章</a></div></div></nav><main id=main-content><article class="single container"><header class=single-header><div class=flex><h1>从 netctl 切换到 systemd-networkd</h1><div class=post-meta><time class=date datetime=2019-06-13T01:00:00.000+00:00 itemprop=datePublished>2019-06-13</time>
/
<span><a href=#disqus_thread class=comment-link>Comments</a></span></div><div class=tag-container><a style=text-decoration:none href=https://xuanwo.io/tags/systemd><span>systemd</span></a>
<a style=text-decoration:none href=https://xuanwo.io/tags/archlinux><span>archlinux</span></a></div></div></header><div class=post><p>晚上的时候临时起意决定把网络管理器从 <code>netctl</code> 切换到 <code>systemd-networkd</code>，切换的过程意外的顺畅。本文记录了一下切换的过程并简单介绍一下 <code>systemd-networkd</code> + <code>iwd</code> 的组合如何使用。</p><hr><h2 id=heading>出场人物介绍</h2><h3 id=netctl>netctl</h3><p>netctl 是 archlinux 的亲儿子，上游就在 <a href=https://git.archlinux.org/netctl.git/>https://git.archlinux.org/netctl.git/</a>，也是除了 <code>systemd-networkd</code> 之外（这是 systemd 钦定的），唯一一个进入 base 组的网络管理工具，说是官方钦定也不为过。netcl 依赖 dhcpcd 或者 dhclient 来获取动态 IP 地址，通过 <code>wpa_supplicant</code> 来访问加密的 WiFi，提供了 <code>wifi-menu</code> 供用户在命令行下交互式地选择热点并输入密码。同时还提供了一系列的 systemd service 文件（<code>netctl@.service</code>，<code>netctl-ifplugd@.service</code>，<code>netctl-auto@.service</code>）来帮助用户进行配置，比如在开启了 <code>netctl-auto@&lt;interface>.service</code> 之后，你的网卡就能在可选的 profile 中自动切换。</p><h3 id=systemd-networkd>systemd-networkd</h3><p>正如它的名字所暗示的，这是 systemd 全家桶的一员。它主要负责的是检测并配置网络设备，特别的是它还能够用来配置 <code>systemd-nspawn</code> 启动的容器的网络。</p><h3 id=iwd>iwd</h3><p>iwd (iNet wireless daemon) 是 Intel 开发，用于取代 <code>wpa_supplicant</code> 的 WiFi 后端。它的主要目标是通过不依赖任何外部库而是最大限度的利用 Linux 内核提供的功能来优化资源利用率。iwd 可以很好的跟 systemd-network 配合使用。</p><h2 id=heading-1>使用场景介绍</h2><p>平时只需要连接 3 个 Wi-Fi：家里的，公司的，手机的，没有频繁切换/增加/修改/删除 Wi-Fi 配置的需求，所以我不需要一个常驻通知区域的服务来进行切换。此外，我的 VPN 已经全部通过 systemd 来进行管理了，所以也不需要网络管理工具替我做这些操作。我需要的是这样的一个工具组合：一个负责管理网络设备，一个负责连接 WiFi 并进行认证。之前的组合是 <code>netctl</code> + <code>wpa_supplicant</code>，现在我有了新欢：<code>systemd-networkd</code> + <code>iwd</code>。</p><h2 id=heading-2>如何使用</h2><h3 id=-netctl>停用 netctl</h3><p>首先需要停用 netctl 的相关服务，避免多个网络管理工具在一起打架。</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>:<span style=color:#666>)</span> systemctl stop netctl-auto@&lt;interface&gt;.service
:<span style=color:#666>)</span> systemctl disable netctl-auto@&lt;interface&gt;.service
</code></pre></div><h3 id=heading-3>配置网卡</h3><p>然后按照 Wiki 的指示写无线网卡的配置，放在 <code>/etc/systemd/network</code> 下。</p><p>对无线网卡来说，最小化的配置是这样的：</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#007020;font-weight:700>[Match]</span>
<span style=color:#4070a0>Name</span><span style=color:#666>=</span><span style=color:#4070a0>wlp2s0</span>

<span style=color:#007020;font-weight:700>[Network]</span>
<span style=color:#4070a0>DHCP</span><span style=color:#666>=</span><span style=color:#4070a0>ipv4</span>
</code></pre></div><ul><li><code>Match</code> 主要是用于匹配管理的设备，可以通过设备名，MAC 地址等来选择</li><li><code>Network</code> 用来做网络相关的具体配置，比如 DHCP，DNS 等</li></ul><p>我的本地开启了 coredns 作为 DNS 服务，所以我需要额外加一些配置来通过 DHCP 来获取 IPv4 地址，但是不使用 DHCP 下发的 DNS。</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#007020;font-weight:700>[Match]</span>
<span style=color:#4070a0>Name</span><span style=color:#666>=</span><span style=color:#4070a0>wlan0</span>

<span style=color:#007020;font-weight:700>[Network]</span>
<span style=color:#4070a0>DHCP</span><span style=color:#666>=</span><span style=color:#4070a0>ipv4</span>
<span style=color:#4070a0>DNS</span><span style=color:#666>=</span><span style=color:#4070a0>127.0.0.1</span>

<span style=color:#007020;font-weight:700>[DHCP]</span>
<span style=color:#4070a0>UseDNS</span><span style=color:#666>=</span><span style=color:#4070a0>false</span>
</code></pre></div><blockquote><p>iwd 启动的时候似乎会修改网络设备的名字，我的网卡被修改成了 wlan0</p></blockquote><p>在配置写好之后就可以启动 <code>systemd-networkd</code> 的服务啦：</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>:<span style=color:#666>)</span> systemctl start systemd-netword
</code></pre></div><p>如果修改了网络配置，只需要 restrart 即可。</p><p>更具体的配置可以参阅 ArchWiki 或者 <code>man systemd-networkd</code>。</p><h3 id=-iwd>配置 iwd</h3><p>iwd 不是自带的软件包，所以首先需要自行安装：</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>:<span style=color:#666>)</span> pacman -S iwd
</code></pre></div><p>在开始使用之前，我们需要 start 并且 enable iwd 服务：</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>:<span style=color:#666>)</span> systemctl start iwd
:<span style=color:#666>)</span> systemctl <span style=color:#007020>enable</span> iwd
</code></pre></div><p>然后就可以用 <code>iwctl</code> 进行管理啦，iwctl 默认会进入一个交互式的命令行界面，使用体验还是很赞的：</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>:<span style=color:#666>)</span> iwctl
<span style=color:#666>[</span>iwd<span style=color:#666>]</span>#
</code></pre></div><p>此时输入 help 会返回支持的所有命令，各个命令都比较直观，只要对 WiFi 的相关技术名词稍有了解就能很快上手，此外这个界面所有命令都支持自动补全，好评。</p><p>首先先看看我们有哪些设备：</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#666>[</span>iwd<span style=color:#666>]</span><span style=color:#60a0b0;font-style:italic># device list</span>
Devices                                   *
--------------------------------------------------------------------------------
Name                Address             Powered   Adapter   Mode
--------------------------------------------------------------------------------
wlan0               xx:xx:xx:xx:xx:xx   on        phy0      station
</code></pre></div><p>这个界面是动态的，右上角的 <code>*</code> 会不断闪烁表明这个界面是实时的。</p><p>然后我们可以手动触发一次 STA 扫描：</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#666>[</span>iwd<span style=color:#666>]</span><span style=color:#60a0b0;font-style:italic># station wlan0 scan</span>
</code></pre></div><p>之后就可以查看有哪些能连接 WiFi 热点了：</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#666>[</span>iwd<span style=color:#666>]</span><span style=color:#60a0b0;font-style:italic># station wlan0 get-networks</span>
                               Available networks                             *
--------------------------------------------------------------------------------
    Network name                    Security  Signal
--------------------------------------------------------------------------------
    CU_SNZQ                         psk       ****
    xjzy                            psk       ****
    Tenda_30BDD0                    psk       ****
    TP-LINK_D82B80                  psk       ****
    TP-LINK_lee                     psk       ****
    ziroom201                       psk       ****
    mhshome                         psk       ****
    TP-LINK_he                      psk       ****
    TP-LINK_450C                    psk       ****
    yuzhe                           psk       ****
    z212-202                        psk       ****
    Bill<span>&#39;</span>s Router                   psk       ****
    tcs                             psk       ****
  &gt; XXXXXXXXXXX                     psk       ****
</code></pre></div><p>这个界面同样是动态的，可以查看当前能连接网络机器信号强度。</p><p>最后就能够选择想要连接 SSID 连接网络了，如果需要输入密码的话，iwd 还会出现一个提示要求输入密码。</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#666>[</span>iwd<span style=color:#666>]</span><span style=color:#60a0b0;font-style:italic># station wlan0 connect XXXXXXXXXXX</span>
</code></pre></div><p>这里有个需要提出来的点：iwd 通过交互式界面成功连接上网络之后，就会自动的在 <code>/var/lib/iwd</code> 下生成对应的配置文件，之后 iwd 自动的进行连接。所以一方面是不需要自己手动的去写配置文件，另一方面是切换过程也是自动的，不需要人工干预。</p><p>iwd 生成的配置文件名是有一定规则的，用 SSID 作为文件名，然后以加密方式作为后缀，比如 <code>*.open</code> 表示这是一个开放网络，<code>*.psk</code> 表示这是一个使用 PSK 加密的网络。</p><h3 id=heading-4>检查状态</h3><p>全部配置好之后可以分别查看一下 WiFi 和网卡的状态：</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>:<span style=color:#666>)</span> iwctl device wlan0 show
                                 Device: wlan0
--------------------------------------------------------------------------------
  Settable  Property            Value
--------------------------------------------------------------------------------
            Name                wlan0
         *  Mode                station
         *  Powered             on
            Address             xx:xx:xx:xx:xx:xx
         *  WDS                 off
            Adapter             phy0
:<span style=color:#666>)</span> networkctl status
●        State: routable
       Address: 192.168.0.103 on wlan0
                xxxx::xxxx:xxxx:xxxx:xxxx on wlan0
       Gateway: 192.168.0.1 <span style=color:#666>(</span>TP-LINK TECHNOLOGIES CO.,LTD.<span style=color:#666>)</span> on wlan0
           DNS: 127.0.0.1
</code></pre></div><h2 id=heading-5>总结</h2><p>systemd 真香，上交底裤我光荣！天灭 networkmanager ！</p><h2 id=heading-6>参考资料</h2><ul><li><a href=https://wiki.archlinux.org/index.php/Systemd-networkd>systemd-networkd - ArchWiki</a></li><li><a href=https://wiki.archlinux.org/index.php/Iwd>iwd - ArchWiki</a></li></ul></div><div id=disqus_thread></div><script type=application/javascript async>let disqus_config=function(){this.page.identifier='\/2019\/06\/13\/switch-to-systemd-networkd\/';this.page.title='从 netctl 切换到 systemd-networkd';this.page.url='https:\/\/xuanwo.io\/2019\/06\/13\/switch-to-systemd-networkd\/';};(function(){let d=document,s=d.createElement('script');s.async=true;s.src='//only0god.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script></article></main><footer class="footer container"><a class=main-nav-link href=/categories/>分类</a>
<a class=main-nav-link href=/tags/>标签</a>
<a class=main-nav-link href=/series/>专题</a>
<a class=main-nav-link href=/blogroll/>友链</a>
<a class=main-nav-link href=/index.xml>订阅</a>
<script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-51515330-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></footer></body></html>