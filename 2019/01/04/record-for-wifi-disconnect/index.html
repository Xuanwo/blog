<!doctype html><html><head><title>记一次 WiFi 断开链接</title><meta charset=utf-8><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="A blog maintained by an interesting programmer."><meta name=keywords content=Technology,Code,Program,Linux,><meta name=author content=Xuanwo><meta property=og:title content="记一次 WiFi 断开链接"><meta property=og:description content="A blog maintained by an interesting programmer."><meta property=og:type content=website><meta property=og:locale content=en_US><meta property=og:url content=https://xuanwo.io/2019/01/04/record-for-wifi-disconnect/><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.0/normalize.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/milligram@1.3.0/dist/milligram.min.css integrity="sha256-Ro/wP8uUi8LR71kwIdilf78atpu8bTEwrK5ZotZo+Zc=" crossorigin=anonymous><link rel=stylesheet href=/css/main.min.css><link href=http://gmpg.org/xfn/11 rel=profile><meta name=generator content="Hugo 0.55.6"></head><body><div id=container><header id=header><div id=header-outer class=outer><div id=header-inner class=inner><a id=main-nav-toggle class=nav-icon href=javascript:;><svg width="1em" height="1em" viewBox="0 0 100 100"><use xlink:href="/svg/fontawesome.svg#bars"/></svg></a><a id=logo class=logo-text href=https://xuanwo.io>Xuanwo&#39;s Blog</a><nav id=main-nav><a class=main-nav-link href=/categories/>分类</a>
<a class=main-nav-link href=/tags/>标签</a>
<a class=main-nav-link href=/series/>专题</a>
<a class=main-nav-link href=/blogroll/>友链</a>
<a class=main-nav-link href=/index.xml>订阅</a>
<a class=main-nav-link href=/about/>关于我</a></nav></div></div></header><section id=main class=outer><article class="article article-type-post" itemscope itemprop=blogPost><div class=article-inner><header class=article-header><h1 class=article-title itemprop=name>记一次 WiFi 断开链接</h1></header><div class=article-meta><a href=/2019/01/04/record-for-wifi-disconnect/ class=article-date><time datetime=2019-01-04T12:00:00.000&#43;00:00 itemprop=datePublished>2019-01-04</time></a><div class=post-categories><div class=article-category><a class=article-category-link href=https://xuanwo.io/categories/code>Code</a></div></div><div class=article-comment-link-wrap><a href=/2019/01/04/record-for-wifi-disconnect/#disqus_thread class=article-comment-link>Comments</a></div></div><div class=article-entry itemprop=articleBody><p>今天下午的时候我的 WiFi 出现了一次时长大约为两秒的断开链接，当时正在抢回家的车票，面对突如其来的 <code>ERR_ADDRESS_UNREACHABLE</code> 感到很是愤怒，还在公司的群里问了句刚才 Office 的网络是不是闪断了一下。但是网络组的同事表示监控无异常，较真的我当时就不信了，要不是网络出问题，好端端的电脑怎么会自己断开链接呢？其实结果还真的差不离。。。</p><h2 id=致命华彩>致命华彩</h2><p>网络组表示他们那边没有看出来什么问题，于是我 <code>journalctl -xe</code> 看了看，发现了一些可能有关的信息：</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>Jan <span style=color:#40a070>04</span> <span style=color:#40a070>13</span>:18:12 thinkpad-x1-carbon kernel: wlp2s0: disassociated from <span style=color:#40a070>06</span>:69:6c:a9:45:6d <span style=color:#666>(</span>Reason: <span style=color:#bb60d5>8</span><span style=color:#666>=</span>DISASSOC_STA_HAS_LEFT<span style=color:#666>)</span>
Jan <span style=color:#40a070>04</span> <span style=color:#40a070>13</span>:18:12 thinkpad-x1-carbon skypeforlinux<span style=color:#666>[</span><span style=color:#40a070>1944</span><span style=color:#666>]</span>: ioctl failed <span style=color:#007020;font-weight:700>for</span> wlan0, <span style=color:#bb60d5>errno</span> <span style=color:#666>=</span> <span style=color:#40a070>19</span> <span style=color:#666>(</span>No such device<span style=color:#666>)</span>
Jan <span style=color:#40a070>04</span> <span style=color:#40a070>13</span>:18:12 thinkpad-x1-carbon wpa_actiond<span style=color:#666>[</span><span style=color:#40a070>864</span><span style=color:#666>]</span>: Interface <span style=color:#4070a0>&#39;wlp2s0&#39;</span> lost connection to network <span style=color:#4070a0>&#39;yunify-ldap&#39;</span>
Jan <span style=color:#40a070>04</span> <span style=color:#40a070>13</span>:18:15 thinkpad-x1-carbon kernel: wlp2s0: authenticate with <span style=color:#40a070>06</span>:69:6c:a9:45:6d
Jan <span style=color:#40a070>04</span> <span style=color:#40a070>13</span>:18:15 thinkpad-x1-carbon kernel: wlp2s0: send auth to <span style=color:#40a070>06</span>:69:6c:a9:45:6d <span style=color:#666>(</span>try <span style=color:#40a070>1</span>/3<span style=color:#666>)</span>
Jan <span style=color:#40a070>04</span> <span style=color:#40a070>13</span>:18:15 thinkpad-x1-carbon kernel: wlp2s0: authenticated
Jan <span style=color:#40a070>04</span> <span style=color:#40a070>13</span>:18:15 thinkpad-x1-carbon kernel: wlp2s0: associate with <span style=color:#40a070>06</span>:69:6c:a9:45:6d <span style=color:#666>(</span>try <span style=color:#40a070>1</span>/3<span style=color:#666>)</span>
Jan <span style=color:#40a070>04</span> <span style=color:#40a070>13</span>:18:15 thinkpad-x1-carbon kernel: wlp2s0: RX AssocResp from <span style=color:#40a070>06</span>:69:6c:a9:45:6d <span style=color:#666>(</span><span style=color:#bb60d5>capab</span><span style=color:#666>=</span>0x1 <span style=color:#bb60d5>status</span><span style=color:#666>=</span><span style=color:#40a070>0</span> <span style=color:#bb60d5>aid</span><span style=color:#666>=</span><span style=color:#40a070>1</span><span style=color:#666>)</span>
Jan <span style=color:#40a070>04</span> <span style=color:#40a070>13</span>:18:15 thinkpad-x1-carbon kernel: wlp2s0: associated
Jan <span style=color:#40a070>04</span> <span style=color:#40a070>13</span>:18:15 thinkpad-x1-carbon kernel: wlp2s0: Limiting TX power to <span style=color:#40a070>27</span> <span style=color:#666>(</span><span style=color:#40a070>30</span> - <span style=color:#40a070>3</span><span style=color:#666>)</span> dBm as advertised by <span style=color:#40a070>06</span>:69:6c:a9:45:6d
Jan <span style=color:#40a070>04</span> <span style=color:#40a070>13</span>:18:15 thinkpad-x1-carbon wpa_actiond<span style=color:#666>[</span><span style=color:#40a070>864</span><span style=color:#666>]</span>: Interface <span style=color:#4070a0>&#39;wlp2s0&#39;</span> reestablished connection to network <span style=color:#4070a0>&#39;yunify-ldap&#39;</span></code></pre></div><p>在 13:18 分的时候突然出现了一次重连，这是为啥呢，明明我在工位上都没有动，为啥网络自己就断开了？我需要搞明白这个 <code>DISASSOC_STA_HAS_LEFT</code> 是什么意思。外事不决问 Google，简单搜索一下就能找到对这个错误的解释：</p><blockquote><p><strong>Reason</strong>: Disassociated because sending STA is leaving (or has left) BSS</p><p><strong>Explanation</strong>: Operating System moved the client to another access point using non-aggressive load balancing.</p></blockquote><p>emmmm，我现在问题反而更多了，<code>STA</code> 是啥，<code>BSS</code> 又是啥，<code>non-aggressive load balancing</code> 又是啥？</p><h2 id=恕瑞玛的传承>恕瑞玛的传承</h2><h3 id=背景知识>背景知识</h3><p>想要解决这些问题，需要先补充一些背景知识。</p><p>首先是耳熟能详的 <code>LAN</code>，<code>LAN</code> 是 <code>local area network</code> 的缩写，中文翻译为局域网，一般用来指有限网络。而 <code>WLAN</code> 就是 <code>Wireless LAN</code>，我们常说的无线局域网。我们日常挂在嘴边的 <code>Wi-Fi</code> 是创建于 <a href=https://zh.wikipedia.org/wiki/IEEE_802.11>IEEE 802.11 标准</a> 的无线局域网技术，有时候看到的 <code>11b</code>，<code>11n</code> 就是 <code>IEEE 802.11</code> 下的不同标准。</p><p>这里的 <code>STA</code> 是 <code>Station</code> 的缩写，表示连接到无线网络中的一个设备，在这里我的电脑就是一个 <code>STA</code>。而 <code>AP</code> 则是 <code>Access Point</code> 的缩写，表示接入点，是无线网络设备中一类特殊节点，无线网络中的其他类型节点可以通过 <code>AP</code> 与无线网络的内部或者外部进行通信。</p><p><code>SSID</code> 大家肯定都很熟悉了，其实这是 <code>Service Set Identifier</code> 的缩写。<code>Service Set</code> （服务集）是无线局域网中的一个术语，用来描述 802.11 网络中的构成单位，是一组互相关联的无线设备。服务集有着不同的种类，规范中分别定义了如下三种：</p><ul><li><code>BSS</code>（基本服务设置，basic service sets）</li><li><code>IBSS</code>（独立基本服务设置，independent BSS）</li><li><code>ESS</code>（扩展服务设置，extended service sets）</li></ul><p>其中 <code>IBSS</code> 属于对等拓扑模式，也叫做 <code>Ad-Hoc</code>，各客户端之间直接相互连接而不需要 <code>AP</code> 协助。而 <code>BSS</code> 和 <code>ESS</code> 都属于基础架构模式，所有客户端和一个或多个 <code>AP</code> 关联，各客户端间的数据传输通过 <code>AP</code> 中转，各客户端之间不直接相互通信。我们一般家庭中常用的就是 <code>BSS</code>，只有一个 <code>AP</code>，所有设备都连接到这个 <code>AP</code> 上。而在 <code>ESS</code> 中，会同时存在多个 <code>AP</code>，他们共享同一个 <code>ESSID</code>。</p><blockquote><p>在这里补充说明一下 <code>ESSID</code> 与 <code>BSSID</code>：<code>SSID</code> 根据标识方式可以细分为两种，其中 <code>BSSID</code> 是 <code>AP</code> 的 <code>MAC</code> 地址，而 <code>ESSID</code> 是最长 32 字节区分大小写的字符串，我们常说的 <code>SSID</code> 其实就是 <code>ESSID</code>。</p></blockquote><p>在同一个 <code>ESS</code> 的不同 <code>BSS</code> 中间切换的过程叫做漫游。</p><h3 id=无线接入>无线接入</h3><p>在介绍了一些背景之后，下面需要了解一下 <code>WLAN</code> 是如何接入的。</p><p>客户端与 <code>AP</code> 之间的通信是由 <code>802.11 Mac</code> 层规定的，大致上分为三步：</p><ul><li><code>Scan</code>，扫描</li><li><code>Authentication</code>，认证</li><li><code>Association</code>，关联</li></ul><p>扫描分为主动扫描和被动扫描：我们手机打开 Wifi 界面时候通常需要等待一会儿才能显示出所有的 <code>SSID</code>，这个时候手机就是在做主动扫描，手机会在标准规定的 13 个信道中广播一个 <code>Probe Request Frame</code>，收到这个 <code>Frame</code> 的 <code>AP</code> 会根据自己的设置决定是否返回带有自己的 <code>SSID</code>，加密方式等信息的 <code>Probe Response</code>。而被动扫描则是侦听 <code>AP</code> 定时发来的 <code>Beacon Frame</code>，这个帧提供了 <code>AP</code> 和所在 <code>BSS</code> 的信息。</p><p>现在我们选择了一个 <code>SSID</code>，手机根据 <code>SSID</code> 的加密方式会通过不同的方式进行认证，这个阶段就是认证阶段。标准中定义了很多加密方式，我这里就不一一列出来了，我们最常见就是 <code>WPA2-PSK</code>。</p><p>在认证通过之后，<code>AP</code> 会向 <code>STA</code> 返回认证响应信息，这时候就会进入关联阶段。<code>STA</code> 会向 <code>AP</code> 发起关联请求，而 <code>AP</code> 则会创建一个 <code>Association ID</code> 并返回一个成功的关联响应。到了这是，<code>STA</code> 就已经成功的通过 <code>AP</code> 连入无线网络了。</p><p>在连入无线网络之后，<code>STA</code> 仍然会去侦听 <code>AP</code> 发来的 <code>Beacon Frame</code>，<code>STA</code> 根据相同 <code>SSID</code> 不同 <code>AP</code> 发来的 <code>Beacon Frame</code> 来确定哪个 <code>AP</code> 信号最强。假设当前连接的是 <code>AP A</code>，但是 <code>STA</code> 发现有个 <code>AP B</code> 跟 <code>AP A</code> 的 <code>SSID</code> 相同，但是信号更强，那么 <code>STA</code> 就会试着向 <code>AP B</code> 发送关联请求。<code>AP B</code> 在返回了关联响应之后会通过局域网来通知 <code>AP A</code>，这个 <code>STA</code> 已经被我接管了。这就是我们拿着笔记本在办公室中走来走去的过程中发生的故事。</p><h2 id=虚空锁敌>虚空锁敌</h2><p>好，前面铺垫了那么多，下面终于可以转入正题了。</p><p>结果就是：<strong>我也不知道确切原因</strong>。</p><p>首先有个技术叫做 <code>Client Load Balance</code>，思科那边称之为 <code>Aggressive Load Balancing</code>，基本思想是在 <code>STA</code> 向 <code>AP</code> 发起关联请求的时候，<code>AP</code> 根据事先设置好的负载策略（比如最大客户端数量，最大流量等）来决定接受还是拒绝请求。但是这个技术核心要点是只作用于关联阶段，只要成功连上，就不会主动断开你的连接。（有时候在人多的地方死活连不上 WiFi，但是只要连上了就一直能用，就是这么个原因。）因此我的电脑主动断开肯定不是 <code>AP</code> 的负载均衡问题。</p><p>我搜索了一下这个 <code>non-aggressive load balancing</code>，发现只有一处提到，其他的地方基本都是全文引用的。包括思科在内的多家厂商都没有提过这个词，Linux 内核里面也没有搜索到相关信息，而作者给出两个引用都已经 404 了，所以无从得知这个 <code>non-aggressive load balancing</code> 到底是怎么来的。</p><blockquote><p>现在的猜想是当时信号不是很稳定，Kernel 认为自己离开了 BSS，于是断开了链接，过了一会儿收到了 Beacon 帧，于是重新连接了上去。</p></blockquote><p>之前的猜想是这样，但是重新看了下 log 之后发现我的设备会很有规律的每过 300s 就断开重连一次：</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#666>[</span><span style=color:#40a070>153162</span>.962047<span style=color:#666>]</span> wlp2s0: disassociated from <span style=color:#40a070>06</span>:69:6c:a9:45:6d <span style=color:#666>(</span>Reason: <span style=color:#bb60d5>8</span><span style=color:#666>=</span>DISASSOC_STA_HAS_LEFT<span style=color:#666>)</span>
<span style=color:#666>[</span><span style=color:#40a070>153464</span>.350214<span style=color:#666>]</span> wlp2s0: disassociated from <span style=color:#40a070>06</span>:69:6c:a9:45:6d <span style=color:#666>(</span>Reason: <span style=color:#bb60d5>8</span><span style=color:#666>=</span>DISASSOC_STA_HAS_LEFT<span style=color:#666>)</span>
<span style=color:#666>[</span><span style=color:#40a070>153766</span>.738503<span style=color:#666>]</span> wlp2s0: disassociated from <span style=color:#40a070>06</span>:69:6c:a9:45:6d <span style=color:#666>(</span>Reason: <span style=color:#bb60d5>8</span><span style=color:#666>=</span>DISASSOC_STA_HAS_LEFT<span style=color:#666>)</span></code></pre></div><p>我司的网络设备跟我的 PC 之间大约的确是有点故事了（耸肩，下个星期看看别人的 PC 有没有一样的问题。</p><h2 id=答读者问>答读者问</h2><blockquote><p>搞什么嘛，研究了半天结果不还是信号不稳定，网络抖动嘛？</p></blockquote><p>结果本身并不重要，重要的是我在这个过程中获得了乐趣~</p><blockquote><p>这个不明觉历的小标题是什么意思？</p></blockquote><p>他们是 LOL 中英雄的技能。</p><p>其中致命华彩是烬的 W 技能，恕瑞玛的传承是沙皇的被动技能，虚空锁敌是卡莎的 W 技能~</p><blockquote><p>说好的日本游记呢？</p></blockquote><p>在写了。</p><h2 id=参考资料>参考资料</h2><ul><li><a href=https://www.aboutcher.co.uk/2012/07/linux-wifi-deauthenticated-reason-codes/>Linux WiFi: Deauthenticated Reason Codes</a></li><li><a href=https://www.cnblogs.com/pyj63/p/8046181.html>wifi的基础知识及原理1</a></li><li><a href=https://zh.wikipedia.org/wiki/Wi-Fi>Wi-Fi</a></li><li><a href=https://zh.wikipedia.org/wiki/IEEE_802.11>IEEE 802.11</a></li><li><a href=https://zh.wikipedia.org/wiki/%E6%9C%8D%E5%8A%A1%E9%9B%86_(%E6%97%A0%E7%BA%BF%E5%B1%80%E5%9F%9F%E7%BD%91)>服务集</a></li><li><a href=https://zh.wikipedia.org/wiki/%E7%84%A1%E7%B7%9A%E9%9A%A8%E6%84%8F%E7%B6%B2%E8%B7%AF>Ad-Hoc</a></li><li><a href=https://witestlab.poly.edu/blog/802-11-wireless-lan-2/>Understanding the 802.11 Wireless LAN MAC frame format</a></li><li><a href=https://devopedia.org/wi-fi-mac-layer>Wi-Fi MAC layer</a></li><li><a href=https://documentation.meraki.com/MR/WiFi_Basics_and_Best_Practices/802.11_Association_process_explained>802.11 Association process explained</a></li><li><a href=https://www.juniper.net/documentation/en_US/junos-space-apps/network-director3.1/topics/concept/wireless-scanning.html>Understanding Wireless Scanning</a></li><li><a href=https://www.draytek.com/en/faq/faq-wlan/wlan.vigorap/what-is-ap-load-balance/>What is AP Load Balance?</a></li></ul></div><div class=article-toc></div><footer class=article-footer><ul class=article-tag-list><li class=article-tag-list-item><a class=article-tag-list-link href=https://xuanwo.io/tags/linux>Linux</a></li><li class=article-tag-list-item><a class=article-tag-list-link href=https://xuanwo.io/tags/network>Network</a></li></ul></footer></div><nav id=article-nav><a href=/2019/01/05/share-with-luck-2nd/ id=article-nav-newer class=article-nav-link-wrap><div class=article-nav-title><span>&lt;</span>&nbsp;
随缘分享第 2 期</div></a><a href=/2018/12/27/pit-stepping-record-for-japan/ id=article-nav-older class=article-nav-link-wrap><div class=article-nav-title>日本旅游不完全踩坑记录&nbsp;<span>&gt;</span></div></a></nav></article><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){this.page.identifier='\/2019\/01\/04\/record-for-wifi-disconnect\/';this.page.title='记一次 WiFi 断开链接';this.page.url='https:\/\/xuanwo.io\/2019\/01\/04\/record-for-wifi-disconnect\/';};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"only0god"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section><footer id=footer><div class=outer><div id=footer-info class=inner>&copy; 2019 Xuanwo&#39;s Blog&nbsp;
Powered by <a href=https://gohugo.io target=_blank>Hugo</a></div></div><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-51515330-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js></script><script>tocbot.init({tocSelector:'.article-toc',contentSelector:'.article-entry',headingSelector:'h1, h2, h3, h4, h5',});</script><script>document.getElementById('main-nav-toggle').addEventListener('click',function(){var header=document.getElementById('header');if(header.classList.contains('mobile-on')){header.classList.remove('mobile-on');}else{header.classList.add('mobile-on');}});</script></footer></div></body></html>