<!doctype html><html><head><title>Python包分发详解</title><meta charset=utf-8><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="A blog maintained by an interesting programmer."><meta name=keywords content=Technology,Code,Program,Linux,><meta name=author content=Xuanwo><meta property=og:title content=Python包分发详解><meta property=og:description content="A blog maintained by an interesting programmer."><meta property=og:type content=website><meta property=og:locale content=en_US><meta property=og:url content=https://xuanwo.io/2015/11/03/python-packages/><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=https://xuanwo.io/css/main.min.f1117337552fb8079b063a89514739c5a687cc73d70687f23e488eb37c3047b1.css integrity="sha256-8RFzN1UvuAebBjqJUUc5xaaHzHPXBofyPkiOs3wwR7E="><link href=http://gmpg.org/xfn/11 rel=profile><meta name=generator content="Hugo 0.55.6"></head><body><nav class=nav><div class=nav-container><div class=brand><a href=https://xuanwo.io>Xuanwo&#39;s Blog</a></div><div class=links><a class=main-nav-link href=/about/>关于我</a>
<a class=main-nav-link href=/posts/>文章</a></div></div></nav><main id=main-content><article class="single container"><header class=single-header><div class=flex><h1>Python包分发详解</h1><div class=post-meta><time class=date datetime=2015-11-03T15:24:06.000&#43;00:00 itemprop=datePublished>2015-11-03</time>
/
<span><a href=#disqus_thread class=comment-link>Comments</a></span></div><div class=tag-container><a style=text-decoration:none href=https://xuanwo.io/tags/python><span>Python</span></a></div></div></header><div class=post><p>用Python写过不少的脚本，现在要把脚本打包成模块并进行发布，然后才明白脚本Boy到正规的码农差距有多大= =。
踩了很多天的坑之后，自己学习到了Python的包分发机制，以及如何利用Pypi向全世界分发自己的模块。现在简单地做一些整理。</p><h1 id=python包机制>Python包机制</h1><blockquote><p>包是一个模块或模块/子模块的集合，一般情况下被压缩到一个压缩包中。
其中包含
1. 依赖信息
2. 将文件拷贝到标准的包搜索路径的指令。
3. 编译指令(如果在安装前代码必须被编译的话)。</p></blockquote><p>也就是说，为了分发模块，我们需要把模块的依赖信息和模块一起打包。在Python中，这个打包好的可分发的文件一般以<code>.egg</code>结尾，其作用可以理解为java中的jar。Python的包管理以及分发曾经经历过非常混乱的一段时期，但是如今已经基本稳定（或者说，流行？）为两个套件：</p><ul><li>打包&amp;分发：<a href=https://pythonhosted.org/setuptools/>Setuptools</a></li><li>安装&amp;管理：<a href=https://pip.readthedocs.org/en/stable/>pip</a></li></ul><h1 id=准备工作>准备工作</h1><h2 id=注册pypi>注册Pypi</h2><blockquote><p>Pypi - the Python Package Index
Pypi是Python语言包的仓库，全世界所有开源Python开发者都会在Pypi上提交&amp;下载软件包</p></blockquote><p>为了我们后续的提交操作，我们需要首先<a href="https://pypi.python.org/pypi?%3Aaction=register_form">注册</a>一个Pypi的账号，注册非常简单，提供用户名，密码以及邮箱，经过验证之后就注册完成了。</p><h2 id=目录结构>目录结构</h2><p>Python没有严格的工程目录要求，只要有<code>__init__.py</code>在的地方，就会被认为是一个Python的包。但是出于方便协作考虑，可以把自己的源代码与各种脚本分开存放。具体的结构可以学习Github上比较流行的Python项目，选择自己喜欢的即可。</p><h2 id=环境配置>环境配置</h2><p>首先你需要有pip，pip自从<code>3.4</code>版本开始已经随python内置发布，如果使用的版本比较低，可以自己手动进行安装：</p><pre><code>sudo apt-get install python-pip
</code></pre><p>然后我们需要安装<code>setuptools</code>：</p><pre><code>pip install setuptools
</code></pre><h1 id=编写安装脚本>编写安装脚本</h1><p>准备工作就绪之后，我们就可以开始编写安装脚本了。</p><h2 id=填写配置信息>填写配置信息</h2><h3 id=基本框架>基本框架</h3><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>setuptools</span> <span style=color:#007020;font-weight:700>import</span> setup, find_packages <span style=color:#60a0b0;font-style:italic># 引入setuptools包</span>

setup(
    option <span style=color:#666>=</span> values, <span style=color:#60a0b0;font-style:italic># 本质上是一个函数的参数，分行写便于维护</span>
)</code></pre></div><h3 id=参数介绍>参数介绍</h3><h4 id=指定整个包>指定整个包</h4><h4 id=指定单独模块>指定单独模块</h4><h4 id=依赖关系>依赖关系</h4><h4 id=包内数据>包内数据</h4><h4 id=其他数据>其他数据</h4><h4 id=meta-data>Meta-Data</h4><p>Meta-Data| 描述值
&ndash;|&ndash;
<code>name</code> | 包名
<code>version</code> | 此次发布版本
<code>author</code> |作者名
<code>author_email</code> | 作者邮箱
<code>maintainer</code> | 维护者名
<code>maintainer_email</code> | 维护者邮箱
<code>url</code> | 主页
<code>description</code> | 简要描述
<code>long_description</code> | 详细描述
<code>download_url</code> | 下载地址
<code>classifiers</code> | 分类，参见<a href="https://pypi.python.org/pypi?%3Aaction=list_classifiers">此处</a>
<code>platforms</code> | 平台列表
<code>license</code> | 授权协议</p><h3 id=典型配置>典型配置</h3><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>setuptools</span> <span style=color:#007020;font-weight:700>import</span> setup, find_packages
setup(
    name <span style=color:#666>=</span> <span style=color:#4070a0>&#34;HelloWorld&#34;</span>,
    version <span style=color:#666>=</span> <span style=color:#4070a0>&#34;0.1&#34;</span>,
    packages <span style=color:#666>=</span> find_packages(),
    scripts <span style=color:#666>=</span> [<span style=color:#4070a0>&#39;say_hello.py&#39;</span>],

    <span style=color:#60a0b0;font-style:italic># Project uses reStructuredText, so ensure that the docutils get</span>
    <span style=color:#60a0b0;font-style:italic># installed or upgraded on the target machine</span>
    install_requires <span style=color:#666>=</span> [<span style=color:#4070a0>&#39;docutils&gt;=0.3&#39;</span>],

    package_data <span style=color:#666>=</span> {
        <span style=color:#60a0b0;font-style:italic># If any package contains *.txt or *.rst files, include them:</span>
        <span style=color:#4070a0>&#39;&#39;</span>: [<span style=color:#4070a0>&#39;*.txt&#39;</span>, <span style=color:#4070a0>&#39;*.rst&#39;</span>],
        <span style=color:#60a0b0;font-style:italic># And include any *.msg files found in the &#39;hello&#39; package, too:</span>
        <span style=color:#4070a0>&#39;hello&#39;</span>: [<span style=color:#4070a0>&#39;*.msg&#39;</span>],
    },

    <span style=color:#60a0b0;font-style:italic># metadata for upload to PyPI</span>
    author <span style=color:#666>=</span> <span style=color:#4070a0>&#34;Me&#34;</span>,
    author_email <span style=color:#666>=</span> <span style=color:#4070a0>&#34;me@example.com&#34;</span>,
    description <span style=color:#666>=</span> <span style=color:#4070a0>&#34;This is an Example Package&#34;</span>,
    license <span style=color:#666>=</span> <span style=color:#4070a0>&#34;PSF&#34;</span>,
    keywords <span style=color:#666>=</span> <span style=color:#4070a0>&#34;hello world example examples&#34;</span>,
    url <span style=color:#666>=</span> <span style=color:#4070a0>&#34;http://example.com/HelloWorld/&#34;</span>,   <span style=color:#60a0b0;font-style:italic># project home page, if any</span>

    <span style=color:#60a0b0;font-style:italic># could also include long_description, download_url, classifiers, etc.</span>
)</code></pre></div><h2 id=打包>打包</h2><blockquote><p>这个坑踩了很久- -，没有老司机的带的痛苦
与开发环境不同的时候，当用户运行你的包时，使用open等命令是以当前目录为根运行的，所以你必须指定数据所在位置，否则会出现IOError甚至更糟糕的情况</p></blockquote><h3 id=指定需要分发的文件>指定需要分发的文件</h3><p><strong>自动处理</strong></p><p>当没有<code>MANIFEST.in</code>文件时，Setuptools将会按照下面的原则处理文件：</p><ul><li>所有<code>py_modules</code>和<code>packages</code>选项包含的Python源文件</li><li>所有<code>ext_modules</code>或<code>libraries</code>选项指定的C源文件</li><li><code>scripts</code>指定的脚本（*参见<a href=https://docs.python.org/3.5/distutils/setupscript.html#distutils-installing-scripts>Installing Scripts</a>*）</li><li>形如<code>test/test*.py</code>的文件</li><li><code>README.txt</code>（或<code>README</code>），<code>setup.py</code>和<code>setup.cfg</code></li><li>符合<code>package_data</code>选项的所有文件（*参见<a href=https://docs.python.org/3.5/distutils/setupscript.html#distutils-installing-package-data>Installing Package Data</a>*）</li><li>符合<code>data_files</code>选项的所有文件（*参见<a href=https://docs.python.org/3.5/distutils/setupscript.html#distutils-additional-files>Installing Additional Files</a>*）</li></ul><p><em>翻译自<a href=https://docs.python.org/3.5/distutils/sourcedist.html#specifying-the-files-to-distribute>Python官方文档 Specifying the files to distribute</a></em></p><p><strong>手动处理</strong></p><p>一般而言，自动处理已经足够，但是如果想要自己指定的话，则需要编辑<code>MANIFEST.in</code>模板文件。
<code>MANIFEST.in</code>模板文件很简单，每一行都导入或者导出表示符合正则的一类文件。比如说：</p><pre><code># 导入根目录下满足*.txt的文件
include *.txt
# 递归导入examples目录下满足*.txt和*.py的文件
recursive-include examples *.txt *.py
# 导入满足examples/sample?/build的文件夹下所有文件
prune examples/sample?/build
</code></pre><p><em>详细语法参见<a href=https://docs.python.org/3.5/distutils/commandref.html#sdist-cmd>此处</a></em></p><blockquote><p>注意：
当根目录下存在<code>MANIFEST.in</code>文件时，Setuptools将不会再采用自动处理的设定，因此需要在<code>MANIFEST.in</code>文件中指明所有需要导入的文件。</p></blockquote><h3 id=调用数据>调用数据</h3><p>当你需要调用Python包中的文件时，你可以使用下面的方法：</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>pkg_resources</span> <span style=color:#007020;font-weight:700>import</span> resource_string
data <span style=color:#666>=</span> resource_string(__name__, <span style=color:#4070a0>&#39;data.dat&#39;</span>)</code></pre></div><p>此时，指定的<code>data.dat</code>文件将会以二进制文件流的形式赋值到data变量中，你可以按照自己的需要进行进一步处理。比如说：</p><pre><code>from pkg_resources import resource_string
    data = resource_string(__name__, 'example.yml')
    with open('config.yml', 'w') as f:
        f.write(str(data, encoding='utf-8'))
        f.close()
</code></pre><p>上述代码实现了从<code>example.yml</code>中读取数据并保存到<code>config.yml</code>文件中。</p><h3 id=创建源码分发包>创建源码分发包</h3><p>在包的根目录下执行：</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>python setup<span style=color:#666>.</span>py sdist</code></pre></div><p>默认情况下，<code>sdist</code>命令将会为Unix创建<code>gzip</code>压缩文件，为Windows创建<code>zip</code>压缩文件
你也可以添加参数<code>--formats=zip</code>指定生成的文件类型，所有支持的参数见<a href=https://docs.python.org/3.5/distutils/sourcedist.html>此处</a></p><blockquote><p>源码分发似乎不会导入<code>package_data</code>中指定的数据，如果上传本分发包可能导致用户通过<code>pip</code>安装的包中没有需要的数据。</p></blockquote><h3 id=创建二进制分发包>创建二进制分发包</h3><p>除了创建源码分发之外，我们还可以创建基于平台的二进制分发包。
在包的根目录下执行：</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>python setup<span style=color:#666>.</span>py bdist</code></pre></div><p>默认情况下，这个命令将会创建基于自身平台的分发包。
同样的，你也可以添加<code>--format=zip</code>参数来指定生成的文件，支持的参数见<a href=https://docs.python.org/3.5/distutils/builtdist.html>此处</a>
除此之外，也可以使用以下的命令直接生成对应格式的分发包：</p><p>命令|格式
&ndash;|&ndash;
bdist_dumb |tar, gztar, bztar, xztar, ztar, zip
bdist_rpm |rpm, srpm
bdist_wininst | wininst
bdist_msi | msi</p><blockquote><p>这一命令无法跨平台， 在Linux上选择制作<code>wininst</code>分发包时会提示缺乏相应的支持。</p></blockquote><h3 id=创建wheel分发包>创建wheel分发包</h3><p>wheel是新出的分发格式，旨在取代egg，你可以通过下列命令进行安装：</p><pre><code>pip install wheel
</code></pre><p>然后在包的根目录下执行：</p><pre><code>python setup.ppy bdist_wheel
</code></pre><h1 id=上传到pypi>上传到Pypi</h1><h2 id=注册包>注册包</h2><p>在上传我们的包之前，我们需要首先向Pypi提交包的相关信息。
在包的根目录下执行:</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>python setup<span style=color:#666>.</span>py register</code></pre></div><p>没有登陆的话，需要进行登陆；如果已经登陆，直接回车使用默认设置即可。</p><h2 id=上传包>上传包</h2><p>注册完毕后，我们可以提交我们的包了。
在包的根目录下执行：</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>python setup<span style=color:#666>.</span>py sdist bdist_wininst upload</code></pre></div><p>这条命令将会向Pypi提交源码和Win下的安装包，如果需要上传别的包，只要直接写出即可。</p><h1 id=参考资料>参考资料</h1><ul><li><a href=https://github.com/dccrazyboy/pyeco/blob/master/pyeco.rst>Python开发生态环境简介</a></li><li><a href=http://timd.cn/2015/10/20/setuptools/>使用Setuptools构建和分发python包</a></li><li><a href=http://python3-cookbook.readthedocs.org/zh_CN/latest/c10/p08_read_datafile_within_package.html>10.8 读取位于包中的数据文件</a></li><li><a href=https://docs.python.org/3.5/distutils/sourcedist.html>Creating a Source Distribution</a></li><li><a href=https://docs.python.org/3.5/distutils/examples.html>Examples</a></li></ul><h1 id=更新日志>更新日志</h1><ul><li>2015年11月03日 初步完成</li><li>2016年03月30日 修复了部分笔误，添加了一些注释，增加了wheel相关的内容</li></ul></div><div id=disqus_thread></div><script type=application/javascript>let disqus_config=function(){this.page.identifier='\/2015\/11\/03\/python-packages\/';this.page.title='Python包分发详解';this.page.url='https:\/\/xuanwo.io\/2015\/11\/03\/python-packages\/';};(function(){let d=document,s=d.createElement('script');s.async=true;s.src='//only0god.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class="footer container"><a class=main-nav-link href=/categories/>分类</a>
<a class=main-nav-link href=/tags/>标签</a>
<a class=main-nav-link href=/series/>专题</a>
<a class=main-nav-link href=/blogroll/>友链</a>
<a class=main-nav-link href=/index.xml>订阅</a>
<script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-51515330-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></footer></body></html>