<!doctype html><html><head><title>使用Travis CI自动部署Hexo</title><meta charset=utf-8><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="A blog maintained by an interesting programmer."><meta name=keywords content=Technology,Code,Program,Linux,><meta name=author content=Xuanwo><meta property=og:title content="使用Travis CI自动部署Hexo"><meta property=og:description content="A blog maintained by an interesting programmer."><meta property=og:type content=website><meta property=og:locale content=en_US><meta property=og:url content=https://xuanwo.io/2015/02/07/travis-ci-hexo-autodeploy/><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=https://xuanwo.io/css/main.min.f1117337552fb8079b063a89514739c5a687cc73d70687f23e488eb37c3047b1.css integrity="sha256-8RFzN1UvuAebBjqJUUc5xaaHzHPXBofyPkiOs3wwR7E="><link href=http://gmpg.org/xfn/11 rel=profile><meta name=generator content="Hugo 0.55.6"></head><body><nav class=nav><div class=nav-container><div class=brand><a href=https://xuanwo.io>Xuanwo&#39;s Blog</a></div><div class=links><a class=main-nav-link href=/about/>关于我</a>
<a class=main-nav-link href=/posts/>文章</a></div></div></nav><main id=main-content><article class="single container"><header class=single-header><div class=flex><h1>使用Travis CI自动部署Hexo</h1><div class=post-meta><time class=date datetime=2015-02-07T14:00:51.000&#43;00:00 itemprop=datePublished>2015-02-07</time>
/
<span><a href=#disqus_thread class=comment-link>Comments</a></span></div><div class=tag-container><a style=text-decoration:none href=https://xuanwo.io/tags/hexo><span>Hexo</span></a>
<a style=text-decoration:none href=https://xuanwo.io/tags/github-pages><span>Github-Pages</span></a>
<a style=text-decoration:none href=https://xuanwo.io/tags/blog><span>Blog</span></a></div></div></header><div class=post><p>前两天了解到了一个有趣的概念叫持续集成：
&gt; 持续集成是一种软件开发实践。在持续集成中，团队成员频繁集成他们的工作成果，一般每人每天至少集成一次，也可以多次。每次集成会经过自动构建（包括自动测试）的检验，以尽快发现集成错误。许多团队发现这种方法可以显著减少集成引起的问题，并可以加快团队合作软件开发的速度。这篇文章简要介绍了持续集成的技巧和它最新的应用。
然后想到我的博客也恰好满足这样的需求，因为我的博客一旦有了修改，就必须要重新build并且部署，那么能不能用持续集成的思想来改造我部署博客的流程呢？</p><p>在这样的指导思想下，我完成了上一篇文章：<a href=https://xuanwo.io/2015/02/05/VPS-Hexo-Autodeploy/>VPS搭配Github Webhook实现Hexo自动发布</a>，而今天我要介绍一下，在没有VPS的情况下，如何更方便的配置自己的持续集成的博客。</p><h1 id=好处>好处</h1><ul><li>方便：只需要一次配置，便省去了每一次编辑文档后，都需要进行<code>hexo d -g</code>的麻烦，更不必说文章增多之后渲染时间还会增长。</li><li>稳定：这个是最近才发现的，Github被搞了之后，很多人反映不能更新博客了，使用<code>Travis CI</code>，你只要想办法提交一个小md文档，就能进行构建。如果自己手动构建，只要一个文件上传失败，前面的工作都白费了。</li><li>快捷：即使是出差在外，只要能编辑Markdown，就可以撰写博客，使得Hexo拥有类似于WP一致的体验~</li><li>协作：博客的构建完全交由<code>Travis CI</code>进行，所以完全可以通过<code>Hexo</code>+<code>git</code>构建一个多人协作的博客平台。实际上，Hexo的<a href=https://hexo.io/>官网</a>正是这样构建的。</li></ul><h1 id=travis-ci介绍>Travis CI介绍</h1><blockquote><p>Travis CI是在软件开发领域中的一个在线的，分布式的持续集成服务，用来构建及测试在GitHub托管的代码。这个软件的代码同时也是开源的，可以在GitHub上下载到，尽管开发者当前并不推荐在闭源项目中单独使用它。
它提供了多种编程语言的支持，包括Ruby，JavaScript，Java，Scala，PHP，Haskell和Erlang在内的多种语言。许多知名的开源项目使用它来在每次提交的时候进行构建测试，比如Ruby on Rails，Ruby和Node.js。
2012年，Travis CI 决定进行募资以支持后续的开发，在这次募资活动中，许多重量级的科技公司给予了资助。</p></blockquote><p>需要注意的是几个特性：
- 只支持Github
- 支持JavaScript
- 开源，免费</p><p>然后介绍一下它的原理：
Travis CI会在你每一次提交之后生成一个虚拟机来执行你事先安排好的build任务，你可以调整这个虚拟机的软件环境，甚至能执行<code>sudo</code>来进行<code>apt-get install</code>。</p><h1 id=travis-ci配置>Travis CI配置</h1><p>我们知道，Hexo的命令非常简单，一个<code>hexo d -g</code>就可以搞定。困难之处在于，Travis CI并没有对你的库进行push操作的权限。如果直接将私钥放在自己的开源库之中，这无异于将自己的代码库提交权限开放给了所有的Github使用者。所以，为了保护自己，我们需要采取一些配置操作。</p><p><em>感谢Hexo作者<a href=http://zespia.tw/>tommy351</a>提供的操作流程，原文可见于<a href=http://zespia.tw/blog/2015/01/21/continuous-deployment-to-github-with-travis/>用 Travis CI 自動部署網站到 GitHub</a></em></p><h2 id=生成ssh-key>生成SSH Key</h2><p>参见<a href=http://xuanwo.io/2015/02/07/generate-a-ssh-key/>使用Github SSH Key以免去Hexo部署时输入密码</a>
需要注意的是，这个SSH key不应成为你账号的全局SSH key*（因为这样Travis CI就获得了你所有代码库的提交权限，这是不正确的）*，而应该添加至<a href=https://github.com/username/ropename/settings/keys>https://github.com/username/ropename/settings/keys</a> ，这样，你就控制了Travis CI的权限。</p><h2 id=加密私钥>加密私钥</h2><p>下面的操作需要事先配置好gem环境，如果没有可以尝试使用<a href=http://xuanwo.io/2014/08/07/Cloud9/>强大且配置项丰富的在线IDE应用——Cloud9</a>。</p><h3 id=安装travis-ci的命令行工具>安装Travis CI的命令行工具</h3><pre><code>gem install travis
</code></pre><h3 id=登陆travis-ci>登陆Travis CI</h3><p>需要输入Github账号和密码</p><pre><code>travis login --auto
</code></pre><h3 id=加密私钥并上传至travis>加密私钥并上传至Travis</h3><p>正确生成后你会得到两个文件，一个叫<code>ssh_key</code>，一个叫<code>ssh_key.pub</code>。刚才我们将<code>ssh_key.pub</code>添加到了github，下面我们要加密<code>ssh_key</code>这个私钥并且上传到Travis。</p><pre><code>travis encrypt-file ssh_key --add
</code></pre><p>然后Travis的客户端会自动检测当前目录中的git信息，并且添加到<code>.travis.yml</code>中去。在进行此步操作前，目录下要先存在<code>.travis.yml</code>文件，否则会报错。</p><h3 id=指定ssh设置>指定SSH设置</h3><p>在当前目录下新建文件<code>ssh_config</code>，内容为</p><pre><code>Host github.com
  User git
  StrictHostKeyChecking no
  IdentityFile ~/.ssh/id_rsa
  IdentitiesOnly yes
</code></pre><p>然后指定openssl解密后的生成位置，修改Travis自动插入的解密指令(不要照抄，注意修改密钥)</p><pre><code>- openssl aes-256-cbc -K $encrypted_xxxxxxxxxx_key -iv $encrypted_xxxxxxxxxx_iv
  -in travis.enc -out ~/.ssh/id_rsa -d
</code></pre><h3 id=修改目录权限>修改目录权限</h3><p>紧跟那条解密指令，换行输入：</p><pre><code>- chmod 600 ~/.ssh/id_rsa
</code></pre><p>注意yml格式，短杠后面的空格不能省略。</p><h3 id=将密钥加入系统>将密钥加入系统</h3><p>紧跟上一步操作，换行输入：</p><pre><code>- eval $(ssh-agent)
- ssh-add ~/.ssh/id_rsa
</code></pre><h3 id=修改git信息>修改git信息</h3><p>将之前创建的ssh_config复制到Travis的虚拟机中去，输入：</p><pre><code>- cp ssh_config ~/.ssh/config
</code></pre><p>然后指定git使用者信息：</p><pre><code>- git config --global user.name &quot;username&quot;
- git config --global user.email username@example.com
</code></pre><h2 id=build配置>Build配置</h2><p>之前的所有操作都只是为了让Travis CI拥有push权限，下面我们开始进入到真正的Build配置当中。
之前我们用到了一个名为<code>.travis.yml</code>的文件，跟build有关的所有设置都在这个文件里面，下面的操作都在这个文件当中进行。</p><h3 id=指定环境>指定环境</h3><p>在文件中添加如下代码：</p><pre><code>language: node_js

node_js:
- '0.10'   //指定使用node.js最新的稳定版0.10
</code></pre><h3 id=指定分支>指定分支</h3><p>在文件中添加如下代码：</p><pre><code>branches:
  only:
  - blog    //这个分支应当使用自己的源文件分支
</code></pre><p>差点忘了讲- -，本方案只适用于用github来托管自己自己的hexo目录的用户。这里的分支应该使用包含有.md文档的那个分支。</p><h3 id=hexo配置>Hexo配置</h3><p>首先在虚拟机中安装Hexo：</p><pre><code>install:
- npm install hexo-cli -g
- npm install hexo --save
- npm install
</code></pre><p>然后执行Hexo的渲染操作</p><pre><code>script:
- hexo clean   //分开写，方便调试可能出现的错误
- hexo d
- hexo g
</code></pre><p>到这里，你的Travis CI的持续集成已经配置完毕了，最后的<code>.travis.yml</code>文件内容可以参考如下：</p><pre><code>branches:
  only:
  - blog

language: node_js

sudo: false

node_js:
- '0.12'

before_install:
- openssl aes-256-cbc -K $encrypted_xxxxxxxxx_key -iv $encrypted_xxxxxxx_iv
  -in doc/travis.enc -out ~/.ssh/id_rsa -d
- chmod 600 ~/.ssh/id_rsa
- eval $(ssh-agent)
- ssh-add ~/.ssh/id_rsa
- cp doc/ssh_config ~/.ssh/config
- git config --global user.name &quot;yourname&quot;
- git config --global user.email youremail
- git clone -b master git@github.com:yourname/yourrepo.git .deploy_git

install:
- npm install hexo-cli -g
- npm install
- npm install hexo-generator-feed --save
- npm install hexo-generator-sitemap --save
- npm install hexo-deployer-git --save

script:
- hexo clean
- hexo g
- hexo d
</code></pre><h1 id=更新日志>更新日志</h1><ul><li>2015年02月07日 首次发布，感谢Tommy351</li><li>2015年02月16日 跟随Hexo版本更新，修改了相关代码。</li><li>2015年03月22日 Hexo3.0稳定版发布，修改相关代码，并修复部分显示问题。</li><li>2015年04月01日 因为自己的.travis.yml有大幅度修改，所以重新添加了相关代码，避免产生困扰。</li><li>2015年10月23日 修复部分错字，更新了.travis.yml</li></ul></div><div id=disqus_thread></div><script type=application/javascript>let disqus_config=function(){this.page.identifier='\/2015\/02\/07\/travis-ci-hexo-autodeploy\/';this.page.title='使用Travis CI自动部署Hexo';this.page.url='https:\/\/xuanwo.io\/2015\/02\/07\/travis-ci-hexo-autodeploy\/';};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!==-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
let d=document,s=d.createElement('script');s.async=true;s.src='//only0god.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class="footer container"><a class=main-nav-link href=/categories/>分类</a>
<a class=main-nav-link href=/tags/>标签</a>
<a class=main-nav-link href=/series/>专题</a>
<a class=main-nav-link href=/blogroll/>友链</a>
<a class=main-nav-link href=/index.xml>订阅</a>
<script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-51515330-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></footer></body></html>