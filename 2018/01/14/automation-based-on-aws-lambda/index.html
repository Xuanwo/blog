<!doctype html><html><head><title>基于 AWS Lambda 实现自动化</title><meta charset=utf-8><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="A blog maintained by an interesting programmer."><meta name=keywords content="Technology,Code,Program,Linux,"><meta name=author content="Xuanwo"><meta property="og:title" content="基于 AWS Lambda 实现自动化"><meta property="og:description" content="A blog maintained by an interesting programmer."><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="https://xuanwo.io/2018/01/14/automation-based-on-aws-lambda/"><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=https://xuanwo.io/css/main.min.be107db044369d658c06efdc8f7f5462fda2b704c0a580ab8c227b3dad6ac109.css integrity="sha256-vhB9sEQ2nWWMBu/cj39UYv2itwTApYCrjCJ7Pa1qwQk="><script data-ad-client=ca-pub-8380875817494486 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><link href=http://gmpg.org/xfn/11 rel=profile><meta name=generator content="Hugo 0.65.3"></head><body><nav class=nav><div class=nav-container><div class=brand><a href=https://xuanwo.io>Xuanwo's Blog</a></div><div class=links><a class=main-nav-link href=/about/>关于我</a>
<a class=main-nav-link href=/posts/>文章</a></div></div></nav><main id=main-content><article class="single container"><header class=single-header><div class=flex><h1>基于 AWS Lambda 实现自动化</h1><div class=post-meta><time class=date datetime=2018-01-14T10:07:00.000+00:00 itemprop=datePublished>2018-01-14</time>
/
<span><a href=#disqus_thread class=comment-link>Comments</a></span></div><div class=tag-container><a style=text-decoration:none href=https://xuanwo.io/tags/share><span>Share</span></a>
<a style=text-decoration:none href=https://xuanwo.io/tags/software><span>Software</span></a>
<a style=text-decoration:none href=https://xuanwo.io/tags/automation><span>Automation</span></a></div></div></header><div class=post><p>在上一篇文章中我们介绍了 <a href=https://xuanwo.io/2017/12/03/integromat-intro/>Integrmat</a> 这个自动化平台，但是在实际的应用当中，它还是有一些不太符合我们项目需求的地方。基于 AWS Lambda 实现的自动化工具就是我们找到的替代方案，接下来我会将阐述一下项目的需求，然后根据对项目的需求分析为什么 Integrmat 不适合以及基于 AWS Lambda 实现的好处在哪里。之后会介绍一下 AWS Lambda 是什么以及如何实现我们的自动化工具，并分享一些在实现自动化工具中遇到的一些坑。</p><h2 id=项目需求>项目需求</h2><p>我们项目中主要有一下几个部分需要用到自动化工具：</p><ul><li>在 Jenkins 上运行的自动构建出错时自动在 Trello 中创建 Card</li><li>Grafana 报警时自动在 Trello 中创建 Card</li><li>移动到 Done 列表的超过两周的 Card 自动归档</li></ul><h3 id=why-not-integrmat>Why not Integrmat</h3><p>以 <code>Jenkins 出错后在 Trello 中创建 Card</code> 这个需求为例，我们需要的不仅仅是简单的出错之后加个 Card 就可以了。我们需要的是一个 Jenkins 出错到恢复的全生命周期的管理，也就是说根据上一次 Jenkins Job 执行的状态和本次状态，我们会有如下几种情况：</p><table><thead><tr><th>上次状态</th><th>本次状态</th><th>执行操作</th></tr></thead><tbody><tr><td>成功</td><td>成功</td><td>忽略</td></tr><tr><td>成功</td><td>失败</td><td>创建一个新 Card</td></tr><tr><td>失败</td><td>失败</td><td>在之前创建的 Card 中增加新的评论</td></tr><tr><td>失败</td><td>成功</td><td>归档对应的 Card</td></tr></tbody></table><p>这就会带来除了创建 Card 之外额外的操作次数调用，而这些都是计费的。</p><p>不仅如此，我们的 Jenkins 每天 24 小时都在不停的执行 Job，按照并行三个 Job，单个 Job 执行 1 分钟来计算，每天会触发 8640 次。每次 Job 如果失败的话需要操作大约 5 次，成功的话需要操作 2 次。按照 1% 的失败率来计算，我们一个月需要的操作数为 596160 次。对应到 Integrmat 的收费政策，我们需要开通每月 299 刀的最顶级套餐 = =。</p><p>Integrmat 在其优质服务，良好体验的背后，带来是不菲的开销。显然，此路不通。</p><h3 id=why-aws-lambda>Why AWS Lambda</h3><p>分析完了上面的为什么不是 Integrmat 之后，使用 AWS Lambda 的理由就变得非常明显了。</p><ul><li>不想自己从头撸一个 FaaS 框架</li><li>AWS Lambda 很便宜</li></ul><p>AWS 提供的免费套餐中有着如下几条：</p><ul><li>Lambda 每月 100 万个免费请求 （永久）</li><li>DynamoDB 25GB 存储 （永久）</li><li>API Gateway 每月接收 100 万次 （12 个月免费）</li></ul><p>结合前面的计算，AWS 的免费套餐已经完全可以覆盖我们的需求。</p><h2 id=aws-lambda--faas-介绍>AWS Lambda / FaaS 介绍</h2><p>FaaS 是指给 Function 提供运行环境和调度的服务，而 AWS Lambda 则是目前 FaaS 中运用比较广泛的一个服务。用户只需要实现业务逻辑，将代码上传到 AWS 之后，AWS 会负责处理接下来的所有事情：调度，伸缩，高可用，日志等等。而这些只有在方法被调用的时候才会计费，可以真正的做到按需运行，按毫秒计费。更详细的介绍可以看老王之前写的一篇文章 —— <a href=http://jolestar.com/serverless-faas-current-status-and-future/>Serverless/FaaS 的现状和未来</a>。</p><blockquote><p>需要说明的是，从理论上来说任何 FaaS 框架都可以用来实现本文中描述功能，本文以 AWS Lambda 为例只是因为我们项目中刚好在用以及比较便宜而已，并不代表本人的任何倾向。老王的文章中也有介绍各个平台的 FaaS 服务，感兴趣的同学可以去看一看。</p></blockquote><h2 id=如何实现自动化>如何实现自动化</h2><p>我们主要用到了以下工具：</p><ul><li>Lambda</li><li>DynamoDB</li><li>API Gateway</li><li>CloudWatch</li></ul><p>其中 Lambda 会提供函数运行的环境，我们主要使用了 Python 3.6。Lambda 每次运行都是一个完全独立的环境，我们需要接入 DynamoDB 来提供持久化存储的能力。API Gateway 则会对外暴露出一个链接作为 Webhook 来触发 Lambda 运行，CloudWatch 除了收集日志之外，还能够定时触发任务。这四件套下来，基本上就能够覆盖我们开发自动化工具所需要的大部分功能。下面我们就以 <code>Jenkins 出错后在 Trello 中创建 Card</code> 这个需求为例，讲解一下如何实现基于 AWS Lambda 的自动化工具。</p><h3 id=创建函数>创建函数</h3><ul><li>进入 Lambda 的界面，点击右上方的 <code>创建函数</code>。</li><li>选择 <code>从头开始创作</code> 即可。</li><li>填写函数的名字，这个名字在创建好之后是不能修改的。</li><li>选择运行语言，根据自己的喜好选择即可</li><li>选择运行角色，这里我推荐 <code>创建自定义角色</code>。为每一个函数都创建一个独立的角色，这样方便控制权限，以后比较容易分得清。AWS 的 IAM 超级恶心，这是我摸索出来的不太容易出问题的步骤。对 AWS IAM 熟悉的同学可以忽略我的建议。</li><li>点击 <code>创建函数</code></li></ul><p>这样我们的一个函数就创建好了。</p><h3 id=接入服务>接入服务</h3><p>为了能够实现我们上述的需求，我们还需要接入对应的服务： DynamoDB，API Gateway 和 CloudWatch。其中每个函数会默认添加一个 CloudWatch，因此不需要再做额外的配置。DynamoDB 和 API Gateway 都建议先再外部创建好，然后再在 Lambda 中去添加，要不然 AWS 自动创建的 IAM 规则会非常乱，很容易出现各种奇怪的问题。如果对稳定性要求比较高的同学可以将 API Gateway 绑定到一个固定的 version 上，比如创建一个 version 叫做 <code>production</code>，然后再将 <code>production</code> 指向某个具体的版本，这样可以保证线上运行的代码始终是不变的，同时也方便使用 API Gateway 的流量调度来做一些灰度测试之类的。没有这方面需求的同学，可以直接将 API Gateway 绑定到 <code>$LASTEST</code> 上，这样所有的请求都会由最新的代码来执行。</p><h3 id=编辑函数>编辑函数</h3><p>函数创建好之后就进入了函数的配置界面。这个地方 AWS 嵌入了 Cloud9 的在线编辑器，自带语言高亮，缩进和提示，还是比较好用的。当然除了在线编辑之外也可以上传 zip 包或者选择从 S3 上传，之后用到的时候再讲。</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>os</span>
<span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>json</span>
<span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>boto3</span>
<span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>trello</span> <span style=color:#007020;font-weight:700>import</span> TrelloClient

trello <span style=color:#666>=</span> TrelloClient(
    api_key<span style=color:#666>=</span>os<span style=color:#666>.</span>environ[<span style=color:#4070a0>&#39;TRELLO_API_KEY&#39;</span>],
    api_secret<span style=color:#666>=</span>os<span style=color:#666>.</span>environ[<span style=color:#4070a0>&#39;TRELLO_API_SECRET&#39;</span>],
    token<span style=color:#666>=</span>os<span style=color:#666>.</span>environ[<span style=color:#4070a0>&#39;TRELLO_TOKEN&#39;</span>],
    token_secret<span style=color:#666>=</span>os<span style=color:#666>.</span>environ[<span style=color:#4070a0>&#39;TRELLO_TOKEN_SECRET&#39;</span>]
)
board <span style=color:#666>=</span> trello<span style=color:#666>.</span>get_board(os<span style=color:#666>.</span>environ[<span style=color:#4070a0>&#39;TRELLO_BOARD_ID&#39;</span>])
todo_list <span style=color:#666>=</span> board<span style=color:#666>.</span>get_list(os<span style=color:#666>.</span>environ[<span style=color:#4070a0>&#39;TRELLO_TODO_LIST_ID&#39;</span>])
done_list <span style=color:#666>=</span> board<span style=color:#666>.</span>get_list(os<span style=color:#666>.</span>environ[<span style=color:#4070a0>&#39;TRELLO_DONE_LIST_ID&#39;</span>])

dynamodb <span style=color:#666>=</span> boto3<span style=color:#666>.</span>resource(<span style=color:#4070a0>&#39;dynamodb&#39;</span>)
table <span style=color:#666>=</span> dynamodb<span style=color:#666>.</span>Table(os<span style=color:#666>.</span>environ[<span style=color:#4070a0>&#39;DYNAMODB_TABLE&#39;</span>])

SUCCESS <span style=color:#666>=</span> [<span style=color:#4070a0>&#39;SUCCESS&#39;</span>]


<span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>main</span>(event, context):
    event <span style=color:#666>=</span> json<span style=color:#666>.</span>loads(event[<span style=color:#4070a0>&#39;body&#39;</span>])
    name <span style=color:#666>=</span> event[<span style=color:#4070a0>&#39;name&#39;</span>]
    status <span style=color:#666>=</span> event[<span style=color:#4070a0>&#39;build&#39;</span>][<span style=color:#4070a0>&#39;status&#39;</span>]

    q <span style=color:#666>=</span> table<span style=color:#666>.</span>get_item(Key<span style=color:#666>=</span>{<span style=color:#4070a0>&#39;project&#39;</span>: name})
    <span style=color:#60a0b0;font-style:italic># Create a new card if this project is not exist.</span>
    <span style=color:#007020;font-weight:700>if</span> <span style=color:#4070a0>&#39;Item&#39;</span> <span style=color:#007020;font-weight:700>not</span> <span style=color:#007020;font-weight:700>in</span> q:
        <span style=color:#60a0b0;font-style:italic># Nothing need to do if event is successful.</span>
        <span style=color:#007020;font-weight:700>if</span> status <span style=color:#007020;font-weight:700>in</span> SUCCESS:
            <span style=color:#007020;font-weight:700>return</span>
        card <span style=color:#666>=</span> todo_list<span style=color:#666>.</span>add_card(
            name<span style=color:#666>=</span><span style=color:#4070a0>&#39;</span><span style=color:#70a0d0;font-style:italic>%s</span><span style=color:#4070a0> #</span><span style=color:#70a0d0;font-style:italic>%d</span><span style=color:#4070a0> Build </span><span style=color:#70a0d0;font-style:italic>%s</span><span style=color:#4070a0>&#39;</span> <span style=color:#666>%</span> (name, event[<span style=color:#4070a0>&#39;build&#39;</span>][<span style=color:#4070a0>&#39;number&#39;</span>], status),
            desc<span style=color:#666>=</span>event[<span style=color:#4070a0>&#39;build&#39;</span>][<span style=color:#4070a0>&#39;full_url&#39;</span>],
            position<span style=color:#666>=</span><span style=color:#4070a0>&#39;top&#39;</span>
        )
        table<span style=color:#666>.</span>put_item(Item<span style=color:#666>=</span>{
            <span style=color:#4070a0>&#39;project&#39;</span>: name,
            <span style=color:#4070a0>&#39;status&#39;</span>: status,
            <span style=color:#4070a0>&#39;card_id&#39;</span>: card<span style=color:#666>.</span>id
        })
        <span style=color:#007020;font-weight:700>return</span>

    <span style=color:#60a0b0;font-style:italic># If project exists, we should update card depends on project status.</span>
    item <span style=color:#666>=</span> q[<span style=color:#4070a0>&#39;Item&#39;</span>]
    card <span style=color:#666>=</span> trello<span style=color:#666>.</span>get_card(card_id<span style=color:#666>=</span>item[<span style=color:#4070a0>&#39;card_id&#39;</span>])

    <span style=color:#007020;font-weight:700>if</span> status <span style=color:#007020;font-weight:700>in</span> SUCCESS:
        table<span style=color:#666>.</span>delete_item(Key<span style=color:#666>=</span>{<span style=color:#4070a0>&#39;project&#39;</span>: name})
        card<span style=color:#666>.</span>comment(
            <span style=color:#4070a0>&#39;</span><span style=color:#70a0d0;font-style:italic>%s</span><span style=color:#4070a0> #</span><span style=color:#70a0d0;font-style:italic>%d</span><span style=color:#4070a0> Build </span><span style=color:#70a0d0;font-style:italic>%s</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#70a0d0;font-style:italic>%s</span><span style=color:#4070a0>&#39;</span> <span style=color:#666>%</span>
            (name, event[<span style=color:#4070a0>&#39;build&#39;</span>][<span style=color:#4070a0>&#39;number&#39;</span>], status, event[<span style=color:#4070a0>&#39;build&#39;</span>][<span style=color:#4070a0>&#39;full_url&#39;</span>]))
        card<span style=color:#666>.</span>set_closed(True)
        <span style=color:#007020;font-weight:700>return</span>

    <span style=color:#007020;font-weight:700>if</span> status <span style=color:#007020;font-weight:700>not</span> <span style=color:#007020;font-weight:700>in</span> SUCCESS:
        card<span style=color:#666>.</span>comment(
            <span style=color:#4070a0>&#39;</span><span style=color:#70a0d0;font-style:italic>%s</span><span style=color:#4070a0> #</span><span style=color:#70a0d0;font-style:italic>%d</span><span style=color:#4070a0> Build </span><span style=color:#70a0d0;font-style:italic>%s</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#70a0d0;font-style:italic>%s</span><span style=color:#4070a0>&#39;</span> <span style=color:#666>%</span>
            (name, event[<span style=color:#4070a0>&#39;build&#39;</span>][<span style=color:#4070a0>&#39;number&#39;</span>], status, event[<span style=color:#4070a0>&#39;build&#39;</span>][<span style=color:#4070a0>&#39;full_url&#39;</span>]))

    <span style=color:#007020;font-weight:700>return</span>
</code></pre></div><p>以上就是我们实现 <code>Jenkins 出错后在 Trello 中创建 Card</code> 的全部代码。有几个需要拿出来单独讲一下的地方：</p><ul><li>函数运行是调用的 Handler 函数是可以修改的，比如这里就是修改成了 <code>main.main</code>，Lambda 会在代码中寻找 <code>main.py</code> 文件并执行该文件中的 <code>main</code> 函数。</li><li>Handler 函数主要接收两个参数，event 与 context，event 中就是外部传入的数据。如果在 Lambda 外面套了 API Gateway 的话，API Gateway 会增加额外的内容，并且把请求体放到 <code>event['body']</code> 中，因此我们需要 <code>json.loads(event['body'])</code> 才能取到外部传过来的真实值。</li><li>Lambda 环境中自带了 boto3 并且与 IAM 集成了，因此可以不需要额外的认证直接调用已经授权的服务，比如这个地方用到的 <code>dynamodb</code>。</li><li>Lambda 支持设置环境变量，因此可以将一些参数都放到环境变量中并通过 <code>os.environ</code> 来读取。</li><li>如果要在 Lambda 中引用外部的库，则需要将这些库一起打包上传。以这里的 <code>trello</code> 库为例，我们需要执行 <code>pip install py-trello -t .</code> 将这个库及其相关依赖下载到当前目录，然后使用 <code>zip -r ../code.zip *</code> 压缩后上传。</li></ul><p>具体的实现就不再多讲，相信大家都能看懂。</p><h3 id=调试函数>调试函数</h3><p>在代码写好之后，我们可以在页面直接调试。页面右上方可以配置一些测试事件，点击 <code>保存</code> 后点 <code>测试</code> 即可直接运行。运行结果会有对应的日志展示出来，也可以到 CloudWatch 中去查看更为完整的日志，根据日志反馈的情况修改自己的代码即可。</p><blockquote><p>从国内上传代码很是恶心，开着代理也经常出问题，不知道啥原因。</p></blockquote><h2 id=总结>总结</h2><p>这篇文章主要介绍了如何基于 AWS Lambda 来实现一个自动化脚本。</p><p>优点：</p><ul><li>除了偶尔请求 timeout 之外，服务很稳定，上线之后不用费心维护</li><li>自动集成的 CloudWatch 日志挺好用，调试很方便</li></ul><p>缺点：</p><ul><li>调试的过程比较麻烦，不能接入外部的 Git 服务，只能用 AWS 自己的那个</li><li>上线的脚本多了之后维护起来很麻烦，没有一个统一管理的方案</li><li>强依赖 AWS 自己的服务，日后迁移要大改脚本</li></ul><hr><h2 id=动态>动态</h2><ul><li>这篇文章是一月份写的，但是一直到今天（2018.3.4）才写好结尾发出来 = =</li><li>我的 github profile 是有多像一个前端以至于所有公司给我发的 JD 都是前端？</li><li>尼尔半价了，2B 小姐姐赛高</li><li>我永远喜欢薇尔莉特.jpg</li></ul></div><div id=disqus_thread></div><script type=application/javascript async>let disqus_config=function(){this.page.identifier='\/2018\/01\/14\/automation-based-on-aws-lambda\/';this.page.title='基于 AWS Lambda 实现自动化';this.page.url='https:\/\/xuanwo.io\/2018\/01\/14\/automation-based-on-aws-lambda\/';};(function(){let d=document,s=d.createElement('script');s.async=true;s.src='//only0god.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script></article></main><footer class="footer container"><a class=main-nav-link href=/categories/>分类</a>
<a class=main-nav-link href=/tags/>标签</a>
<a class=main-nav-link href=/series/>专题</a>
<a class=main-nav-link href=/blogroll/>友链</a>
<a class=main-nav-link href=/index.xml>订阅</a>
<script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-51515330-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></footer></body></html>