<!doctype html><html><head><title>Xuanzang —— 一款开箱即用的全文搜索引擎</title><meta charset=utf-8><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="A blog maintained by an interesting programmer."><meta name=keywords content="Technology,Code,Program,Linux,"><meta name=author content="Xuanwo"><meta property="og:title" content="Xuanzang —— 一款开箱即用的全文搜索引擎"><meta property="og:description" content="A blog maintained by an interesting programmer."><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="https://xuanwo.io/2018/05/01/xuanzang-intro/"><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=https://xuanwo.io/css/main.min.a285da0837b674a21742d9d9056c807cf8074d0e7b0cd2e85d30ed1ddf2acddd.css integrity="sha256-ooXaCDe2dKIXQtnZBWyAfPgHTQ57DNLoXTDtHd8qzd0="><script data-ad-client=ca-pub-8380875817494486 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><link href=http://gmpg.org/xfn/11 rel=profile><meta name=generator content="Hugo 0.62.0"></head><body><nav class=nav><div class=nav-container><div class=brand><a href=https://xuanwo.io>Xuanwo's Blog</a></div><div class=links><a class=main-nav-link href=/about/>关于我</a>
<a class=main-nav-link href=/posts/>文章</a></div></div></nav><main id=main-content><article class="single container"><header class=single-header><div class=flex><h1>Xuanzang —— 一款开箱即用的全文搜索引擎</h1><div class=post-meta><time class=date datetime=2018-05-01T13:30:00.000+00:00 itemprop=datePublished>2018-05-01</time>
/
<span><a href=#disqus_thread class=comment-link>Comments</a></span></div><div class=tag-container><a style=text-decoration:none href=https://xuanwo.io/tags/golang><span>Golang</span></a>
<a style=text-decoration:none href=https://xuanwo.io/tags/blog><span>Blog</span></a></div></div></header><div class=post><blockquote><p>本文是
<a href=https://xuanwo.io/series/self-made-wheels>Self-made Wheels</a> 系列的第 1 篇文章, 共 8 篇。</p></blockquote><p><a href=https://github.com/Xuanwo/xuanzang>Xuanzang</a>, 中文名：玄奘，是一个支持中文分词的开源全文搜索引擎。其目标是做一个开箱即用，不需要复杂的部署和配置，可以方便的嵌入静态网站的全文搜索引擎。</p><h2 id=heading>使用</h2><p>Xuanzang 的使用非常简单，只需要在 <a href=https://github.com/Xuanwo/xuanzang/releases>releases</a> 处下载实现编译好的二进制文件。按照要求填写一些配置文件，比如：</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>host:<span style=color:#bbb> </span>localhost<span style=color:#bbb>
</span><span style=color:#bbb></span>port:<span style=color:#bbb> </span><span style=color:#40a070>8080</span><span style=color:#bbb>
</span><span style=color:#bbb></span>db_path:<span style=color:#bbb> </span>/project/xuanzang/database<span style=color:#bbb>
</span><span style=color:#bbb></span>index_path:<span style=color:#bbb> </span>/project/xuanzang/index<span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb></span>source:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>type:<span style=color:#bbb> </span>sitemap<span style=color:#bbb>
</span><span style=color:#bbb>  </span>url:<span style=color:#bbb> </span>https://xuanwo.io/sitemap.xml<span style=color:#bbb>
</span><span style=color:#bbb>  </span>duration:<span style=color:#bbb> </span><span style=color:#40a070>3600</span><span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb></span>dictionary:<span style=color:#bbb> </span>/project/xuanzang/dictionary.txt<span style=color:#bbb>
</span><span style=color:#bbb></span>stop_tokens:<span style=color:#bbb> </span>/project/xuanzang/stop_tokens.txt<span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb></span>logger:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>level:<span style=color:#bbb> </span>debug<span style=color:#bbb>
</span><span style=color:#bbb>  </span>output:<span style=color:#bbb> </span>/project/xuanzang/log<span style=color:#bbb>
</span></code></pre></div><p>上述的配置文件将会监听本地的 <code>8080</code> 端口，并使用 <code>/project/xuanzang/database</code> 存放数据库，使用 <code>/project/xuanzang/index</code> 目录存放索引。接下来的 <code>source</code> 指定了源站的类型和两次抓取的间隔时间。对于个人博客而言，一个小时的抓取间隔已经足够了。下面的 <code>dictionary</code> 和 <code>stop_tokens</code> 是 Xuanzang 使用的字典和停止词，如果没有特殊的需求，可以使用项目自带的，在<a href=https://github.com/Xuanwo/xuanzang/tree/master/data>此处</a>下载。<code>logger</code> 则指定了 log 文件的位置和级别。</p><p>接下来就只需要启动 Xuanzang：</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>:<span style=color:#666>)</span> xuanzang -c /path/to/config.yaml
</code></pre></div><p>以搜索我的朋友 <a href=https://pjw.io/>Aspire</a> 为例：</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>:<span style=color:#666>)</span> curl 127.0.0.1:8080?text<span style=color:#666>=</span>aspire
<span style=color:#666>{</span><span style=color:#4070a0>&#34;tokens&#34;</span>:<span style=color:#666>[</span><span style=color:#4070a0>&#34;aspire&#34;</span><span style=color:#666>]</span>,<span style=color:#4070a0>&#34;docs&#34;</span>:<span style=color:#666>[</span><span style=color:#666>{</span><span style=color:#4070a0>&#34;title&#34;</span>:<span style=color:#4070a0>&#34;友情链接 // Xuanwo&#39;s Blog&#34;</span>,<span style=color:#4070a0>&#34;url&#34;</span>:<span style=color:#4070a0>&#34;https://xuanwo.io/blogroll/&#34;</span>,<span style=color:#4070a0>&#34;content_text&#34;</span>:<span style=color:#4070a0>&#34;&#34;</span><span style=color:#666>}</span><span style=color:#666>]</span>,<span style=color:#4070a0>&#34;total&#34;</span>:1<span style=color:#666>}</span>
</code></pre></div><p>接入博客十分容易，只需要通过 Ajax 向 Xuanzang 发出请求，并解析返回的 JSON 插入正确的 DOM，比如：</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#007020;font-weight:700>function</span> search() {
  <span style=color:#007020;font-weight:700>var</span> text <span style=color:#666>=</span> <span style=color:#007020>decodeURI</span>(<span style=color:#007020>window</span>.location.search.substring(<span style=color:#40a070>1</span>).split(<span style=color:#4070a0>&#34;&amp;&#34;</span>)[<span style=color:#40a070>0</span>].split(<span style=color:#4070a0>&#34;=&#34;</span>)[<span style=color:#40a070>1</span>]);
  $(<span style=color:#4070a0>&#34;.archive-category&#34;</span>).text(<span style=color:#4070a0>`</span><span style=color:#4070a0>&#34;</span><span style=color:#70a0d0;font-style:italic>${</span>text<span style=color:#70a0d0;font-style:italic>}</span><span style=color:#4070a0>&#34; 的搜索结果</span><span style=color:#4070a0>`</span>);
  $.getJSON(<span style=color:#4070a0>&#34;/search?text=&#34;</span> <span style=color:#666>+</span> text, <span style=color:#007020;font-weight:700>function</span>(result) {
    $.each(result.docs, <span style=color:#007020;font-weight:700>function</span>(i, field) {
      $(<span style=color:#4070a0>&#34;.archives&#34;</span>).append(<span style=color:#4070a0>`</span><span style=color:#4070a0>&lt;a href=&#34;</span><span style=color:#70a0d0;font-style:italic>${</span>field.url<span style=color:#70a0d0;font-style:italic>}</span><span style=color:#4070a0>&#34;&gt;</span><span style=color:#70a0d0;font-style:italic>${</span>field.title<span style=color:#70a0d0;font-style:italic>}</span><span style=color:#4070a0>&lt;/a&gt;</span><span style=color:#4070a0>`</span>);
    });
  });
};
</code></pre></div><p>在 Search 页面的 Body 中设置 <code>onload="search()"</code> 并在 form 表单中设置 <code>action="/search_result" method="get"</code>。</p><p>具体的实现可以参考<a href=https://github.com/Xuanwo/xuanwo.github.io/commit/3a7049df0a8fb9d685704283cfc0f6fdc264035d>这个 Commit</a>。</p><p>目前本博客的全文搜索就是通过 Xuanzang 实现的，感兴趣的朋友可以试用一下~</p><h2 id=heading-1>实现</h2><p>Xuanzang 解决中文全文搜索的思路非常简单：</p><ol><li>通过事先指定的 sitemap 文件来遍历 & 抓取网页</li><li>使用一个支持中文分词的全文搜索引擎来做索引</li><li>对外暴露一个简化的 API 接口</li></ol><p>接下来我们分别介绍一下这三个部分。</p><h3 id=heading-2>抓取网页</h3><p>现在静态网站的生成工具多如牛毛，每个工具采用的模板都不大一样，因此不可能走为每种静态网站生成工具适配模板的道路。那有没有一种方法可以实时的获取到网站内容的变更呢？那就是 <a href=https://www.sitemaps.org/protocol.html>Sitemap</a>，又叫做站点地图。几乎所有的静态网站生成工具都支持生成 Sitemap，这解决了获取网站内容的问题。同时 Sitemap 除了网址以外，还有 <code>lastmod</code> 属性，可以获取到对应页面的最后修改时间。因此只需要抓取 Sitemap 文件，我们就可以知道整个网站都有哪些页面以及他们上次更新是什么时候了，这样就解决了获取网站内容变更的问题。同时我们可以在本地记录一下索引更新的时间，如果索引更新的时间比网页更新的时间要晚，那就可以直接跳过这个页面，从而避免每次都需要抓取。</p><h3 id=heading-3>中文分词</h3><p>Xuanzang 底层使用了 <a href=https://github.com/huichen>@huichen</a> 开发的 <a href=https://github.com/huichen/wukong>wukong</a>。中文分词这一块没有做什么大的改进，基本上就是直接拿过来用了。虽说搜索的精度还不是很高，但是马马虎虎还能用，对于个人博客而言已经足够了。</p><h3 id=api->API 接口</h3><p>目前对外只提供了一个 <code>GET</code> 接口，返回的数据结构如下：</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#60a0b0;font-style:italic>// Response is the response for search.
</span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020;font-weight:700>type</span> Response <span style=color:#007020;font-weight:700>struct</span> {
	Tokens []<span style=color:#902000>string</span>   <span style=color:#4070a0>`</span><span style=color:#4070a0>json:&#34;tokens&#34;</span><span style=color:#4070a0>`</span>
	Docs   []Document <span style=color:#4070a0>`</span><span style=color:#4070a0>json:&#34;docs&#34;</span><span style=color:#4070a0>`</span>

	Total <span style=color:#902000>int</span> <span style=color:#4070a0>`</span><span style=color:#4070a0>json:&#34;total&#34;</span><span style=color:#4070a0>`</span>
}

<span style=color:#60a0b0;font-style:italic>// Document is the document that scored.
</span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020;font-weight:700>type</span> Document <span style=color:#007020;font-weight:700>struct</span> {
	Title       <span style=color:#902000>string</span> <span style=color:#4070a0>`</span><span style=color:#4070a0>json:&#34;title&#34;</span><span style=color:#4070a0>`</span>
	URL         <span style=color:#902000>string</span> <span style=color:#4070a0>`</span><span style=color:#4070a0>json:&#34;url&#34;</span><span style=color:#4070a0>`</span>
	ContentText <span style=color:#902000>string</span> <span style=color:#4070a0>`</span><span style=color:#4070a0>json:&#34;content_text&#34;</span><span style=color:#4070a0>`</span>
}
</code></pre></div><p>预留了 <code>ContentText</code> 属性，以后会用做提供搜索到的关键字附近的内容。</p><h2 id=heading-4>对比</h2><p>接下来简单的讲一讲 Xuanzang 和市面上其它全文搜索工具的区别。</p><h3 id=lunrjs>Lunr.js</h3><p>Lunr.js 是一个非常 Cool 的项目，但是 Lunr.js 不支持中文分词。不少人通过引入一个分词库并修改 Lunr.js 的 tokenizer 方法解决这个问题，其代价就是不能在浏览器端直接使用，还是需要在服务器端去提供一个服务。从我的角度来看是是已经偏离了它的目标：<code>A bit like Solr, but much smaller and not as bright.</code> ，因此我的博客没有采用这个方案。其他的基于 js 的方案也都或多或少有这样的问题，比如在本地生成一个索引，然后搜索的时候使用 js 去 load 等等，在使用体验上都不是很好，在网站不是部署在国内时，这个问题尤为严重。</p><h3 id=elasticsearch>Elasticsearch</h3><p>（首先， Elasticsearch 是 Java 的，我这个 512M 内存的机器咋跑。。。）</p><p>Elasticsearch 很棒，但是用来做博客的全文搜索，总有一种拿着大炮打蚊子的感觉。我个人只是使用过 API ，没有实际的进行过 ES 的部署和维护，这里就不多说了。</p><h3 id=google-site-search>Google Site Search</h3><p>这大概是接入最方便的方案了，只需要直接跳转到 google 的 <code>site:xuanwo.io %s</code> 即可。缺点是无法控制 Google 的索引行为，也没有办法做到实时的抓取和更新。</p><h3 id=algolia-etc>Algolia etc.</h3><p>还有很多商业化的全文搜索服务，其中最出名的莫过于 <code>Algolia</code> 和 <code>Swiftype</code>。之前试用过他们的服务，搜索效果很赞，但是免费用户限制颇多： algolia 的免费服务最多只能有一万条记录，swiftype 则是只提供了一段时间的免费试用，同时还限制了抓取的频率。</p><h2 id=heading-5>总结</h2><p>Xuanzang 在前人已有工作的基础上提供了一套简单易用的中文网站全文搜索解决方案，不需要复杂的参数调节和运维工作，按照文档部署即可使用，兼容市面上绝大多数静态网站生成工具，各位朋友了解一下？</p><h2 id=heading-6>动态</h2><ul><li>本周给大家推荐的小说： <a href=http://book.zongheng.com/showchapter/189169.html>《雪中悍刀行》</a>，烽火戏诸侯的作品，布局精细，结构宏大，人物刻画生动，文字功底深厚，适合所有喜欢武侠小说的同学~</li><li>背后故事：4 月 29 号睡前有了为自己博客增加全文搜索支持的 Idea，30 号写了一天，并于当天的晚上九点发出了第一个 Release。</li><li>今天去簋街胡大饭馆吃了麻辣小龙虾，麻辣扇贝，馋嘴蛙仔，现在肚子在疯狂的翻腾。。。</li></ul></div><div id=disqus_thread></div><script type=application/javascript async>let disqus_config=function(){this.page.identifier='\/2018\/05\/01\/xuanzang-intro\/';this.page.title='Xuanzang —— 一款开箱即用的全文搜索引擎';this.page.url='https:\/\/xuanwo.io\/2018\/05\/01\/xuanzang-intro\/';};(function(){let d=document,s=d.createElement('script');s.async=true;s.src='//only0god.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script></article></main><footer class="footer container"><a class=main-nav-link href=/categories/>分类</a>
<a class=main-nav-link href=/tags/>标签</a>
<a class=main-nav-link href=/series/>专题</a>
<a class=main-nav-link href=/blogroll/>友链</a>
<a class=main-nav-link href=/index.xml>订阅</a>
<script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-51515330-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></footer></body></html>