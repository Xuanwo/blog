---
export const prerender = true

import BaseLayout from '../../../../layouts/BaseLayout.astro'
import SitePaginator from '../../../../components/SitePaginator.astro'
import { formatDay, loadContentIndex } from '../../../../lib/site-data'
import { paginate, slicePage } from '../../../../lib/pagination'

const legacy = await loadContentIndex()
const pageSize = legacy.site.pagination ?? 10

export async function getStaticPaths() {
  const legacy = await loadContentIndex()
  const pageSize = legacy.site.pagination ?? 10
  const paths = []
  for (const slug of Object.keys(legacy.taxonomies.categories)) {
    const urls = legacy.taxonomies.categories[slug]?.pages ?? []
    const items = urls.map((u) => legacy.pageByUrl.get(u)).filter(Boolean)
    const { totalPages } = paginate(items, pageSize)
    for (let p = 1; p <= totalPages; p++) {
      paths.push({ params: { category: slug, page: String(p) } })
    }
  }
  return paths
}

const slug = String(Astro.params.category)
const current = Number(Astro.params.page)

const entry = legacy.taxonomies.categories[slug]
if (!entry) throw new Error(`Missing category: ${slug}`)
const urls = entry.pages ?? []
const items = urls.map((u) => legacy.pageByUrl.get(u)).filter(Boolean)
const { totalPages } = paginate(items, pageSize)
const list = slicePage(items, pageSize, current)
---

<BaseLayout
  title={entry.name}
  urlPath={current <= 1 ? `/categories/${slug}/` : `/categories/${slug}/page/${current}/`}
>
  <h1 class="text-center text-5xl">{entry.name}</h1>
  <p class="text-center mt-4"></p>
  <ul>
    {list.map((p) => {
      const { day, monthYear } = p?.date ? formatDay(p.date) : { day: '', monthYear: '' }
      return (
        <li class="grid grid-cols-12 mt-8">
          <div class="col-span-2 text-center">
            <span class="block text-5xl font-semibold">{day}</span>
            <span class="block text-sm">{monthYear}</span>
          </div>
          <div class="col-span-10">
            <h3 class="text-2xl leading-relaxed mb-0 mt-0">
              <a href={p?.url}>{p?.title}</a>
            </h3>
            <span class="leading-relaxed">{p?.excerpt}</span>
          </div>
        </li>
      )
    })}
  </ul>
  <SitePaginator
    current={current}
    total={totalPages}
    hrefForPage={(page) =>
      page <= 1 ? `/categories/${slug}/` : `/categories/${slug}/page/${page}/`}
  />
</BaseLayout>
