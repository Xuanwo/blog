<!doctype html><html><head><title>My Solution for DNS Poisoning by AtomDNS</title><meta charset=utf-8><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="A blog maintained by an interesting programmer."><meta name=keywords content="Technology,Code,Program,Linux,"><meta name=author content="Xuanwo"><meta property="og:title" content="My Solution for DNS Poisoning by AtomDNS"><meta property="og:description" content="A blog maintained by an interesting programmer."><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="https://xuanwo.io/2020/04/05/my-solution-for-dns-poisoning-by-atomdns/"><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=https://xuanwo.io/css/main.min.5a9ffcf343273240b691845bba645faa19f2008c05742711b684042a3063818b.css integrity="sha256-Wp/880MnMkC2kYRbumRfqhnyAIwFdCcRtoQEKjBjgYs="><script data-ad-client=ca-pub-8380875817494486 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><link href=http://gmpg.org/xfn/11 rel=profile><meta name=generator content="Hugo 0.68.3"></head><body><nav class=nav><div class=nav-container><div class=brand><a href=https://xuanwo.io>Xuanwo's Blog</a></div><div class=links><a class=main-nav-link href=/about/>About</a>
<a class=main-nav-link href=/posts/>Posts</a></div></div></nav><main id=main-content><article class="single container"><header class=single-header><div class=flex><h1>My Solution for DNS Poisoning by AtomDNS</h1><div class=post-meta><time class=date datetime=2020-04-05T01:00:00.000+00:00 itemprop=datePublished>2020-04-05</time></div><div class=tag-container><a style=text-decoration:none href=https://xuanwo.io/tags/golang><span>golang</span></a>
<a style=text-decoration:none href=https://xuanwo.io/tags/dns><span>dns</span></a></div></div></header><div class=post><blockquote><p>This post is the 9 / 9 post in
<a href=https://xuanwo.io/series/self-made-wheels>Self-made Wheels</a> Series.</p></blockquote><p>I used to be a big fan of <a href=https://github.com/coredns/coredns>coredns</a>: I use it on my laptop, in our team&rsquo;s internal infrastructure and maintain the package for <a href=https://github.com/archlinuxcn/repo>archlinuxcn</a>. Until one day, I want to solve the DNS Pollution problem by <a href=https://github.com/coredns/coredns>coredns</a>. But&mldr;</p><h2 id=coredns-is-not-for-dns-pollution>CoreDNS is not for DNS Pollution</h2><p>It&rsquo;s obvious that I&rsquo;m not the only fan of <a href=https://github.com/coredns/coredns>coredns</a>, there are mainly two solutions via coredns:</p><ul><li>Generate Corefile: as <a href=https://minidump.info/blog/2019/07/coredns-no-dns-poisoning/>https://minidump.info/blog/2019/07/coredns-no-dns-poisoning/</a> does</li><li>Write coredns plugin: like <a href=https://github.com/blahgeek/coredns-chinadns>coredns-chinadns</a></li></ul><h3 id=why-not-generate-corefile>Why not generate corefile?</h3><p>First of all, it&rsquo;s ugly and not suitable for updates automatically. We have to generate the whole <code>Corefile</code> every time domain list updated and make it hard to apply custom updates. For example, I need to forward some internal domains to a DNS server in a VPN. I need to add them in corefile build scripts or build another system to build corefile.</p><p>Then, coredns forward except is not designed for large domains input. forward will read all zone in a slice, and check them one by one:</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#60a0b0;font-style:italic>// Read all domains
</span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020;font-weight:700>func</span> <span style=color:#06287e>parseBlock</span>(c <span style=color:#666>*</span>caddy.Controller, f <span style=color:#666>*</span>Forward) <span style=color:#902000>error</span> {
   <span style=color:#007020;font-weight:700>switch</span> c.<span style=color:#06287e>Val</span>() {
   <span style=color:#007020;font-weight:700>case</span> <span style=color:#4070a0>&#34;except&#34;</span>:
      ignore <span style=color:#666>:=</span> c.<span style=color:#06287e>RemainingArgs</span>()
      <span style=color:#007020;font-weight:700>if</span> <span style=color:#007020>len</span>(ignore) <span style=color:#666>==</span> <span style=color:#40a070>0</span> {
         <span style=color:#007020;font-weight:700>return</span> c.<span style=color:#06287e>ArgErr</span>()
      }
      <span style=color:#007020;font-weight:700>for</span> i <span style=color:#666>:=</span> <span style=color:#40a070>0</span>; i &lt; <span style=color:#007020>len</span>(ignore); i<span style=color:#666>++</span> {
         ignore[i] = plugin.<span style=color:#06287e>Host</span>(ignore[i]).<span style=color:#06287e>Normalize</span>()
      }
      f.ignored = ignore
    <span style=color:#666>...</span>
}

<span style=color:#60a0b0;font-style:italic>// Check one by one
</span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020;font-weight:700>func</span> (f <span style=color:#666>*</span>Forward) <span style=color:#06287e>isAllowedDomain</span>(name <span style=color:#902000>string</span>) <span style=color:#902000>bool</span> {
   <span style=color:#007020;font-weight:700>if</span> dns.<span style=color:#06287e>Name</span>(name) <span style=color:#666>==</span> dns.<span style=color:#06287e>Name</span>(f.from) {
      <span style=color:#007020;font-weight:700>return</span> <span style=color:#007020;font-weight:700>true</span>
   }

   <span style=color:#007020;font-weight:700>for</span> _, ignore <span style=color:#666>:=</span> <span style=color:#007020;font-weight:700>range</span> f.ignored {
      <span style=color:#007020;font-weight:700>if</span> plugin.<span style=color:#06287e>Name</span>(ignore).<span style=color:#06287e>Matches</span>(name) {
         <span style=color:#007020;font-weight:700>return</span> <span style=color:#007020;font-weight:700>false</span>
      }
   }
   <span style=color:#007020;font-weight:700>return</span> <span style=color:#007020;font-weight:700>true</span>
}
</code></pre></div><p>We can use the builtin zone support for better performance:</p><pre><code class=language-caddyfile data-lang=caddyfile>. {
    log
    cache
    forward . 8.8.8.8
}

abc.com def.com {
    log
    cache
    forward . 114.114.114.114
}
</code></pre><p>But we still need to maintain a huge corefile.</p><h3 id=why-not-write-a-plugin>Why not write a plugin?</h3><p>So, why not write a plugin to read domains from a file and forward it to different upstreams? Yes, I tried, and I found <a href=https://github.com/coredns/coredns>coredns</a>&lsquo;s plugin system is a mess.</p><p><a href=https://github.com/coredns/coredns>coredns</a> is chain based, all dns query will be split via zones, so we can&rsquo;t filter and forward them by domains. To handle all domains, we have to design a plugin under root:</p><pre><code class=language-caddyfile data-lang=caddyfile>. {
    filter xxxxx
}
</code></pre><p>Then, we need to design a config that matches something and forward to somewhere, maybe like the following:</p><pre><code class=language-caddyfile data-lang=caddyfile>. {
    filter {
        condition domain_in_file xxxxxxxxxx
        action forward xxxxxxx
    }
    filter {
        condition domain_not_in_file xxxxxxxxxx
        action forward xxxxxx
    }
}
</code></pre><p>Looks perfect for now, let&rsquo;s implement it. Ooooops, we need forward here, why not use the builtin forward? Sorry, we can&rsquo;t. Plugin in coredns doesn&rsquo;t been designed for run standalone or embedded, we can&rsquo;t call other plugins or pass the query to other plugins conveniently. As I described in RFC <a href=https://github.com/coredns/rfc/issues/6>embeddable plugin</a>, many plugins have to implement the same feature.</p><p>So, don&rsquo;t dig deeper, let&rsquo;s jump out of the chaos.</p><h2 id=so-what-am-i-need>So, what am I need?</h2><p>After talking so much, what am I need?</p><ul><li>Forward DNS query to upstreams depends on conditions</li><li>Human-readable config</li><li>Simple deployment, no extra build needed</li><li>No so bad performance</li></ul><p>Although there are other good DNS servers like <a href=https://github.com/shawn1m/overture>overture</a> and <a href=https://github.com/pymumu/smartdns>smartdns</a>, let&rsquo;s build a DNS server for ourselves.</p><h2 id=say-hi-to-atomdns>Say Hi to AtomDNS!</h2><p>With <a href=https://github.com/miekg/dns>dns</a> package support, write a DNS server by go is so simple that we can build one in a half-day: <a href=https://github.com/Xuanwo/atomdns>atomdns</a>.</p><p><a href=https://github.com/Xuanwo/atomdns>atomdns</a> is built by three-part: <code>upstream</code>, <code>match</code> and <code>rules</code>. <code>upstream</code> means a set of DNS servers that dns been forwarded to. <code>match</code> is the match policy, and we support <code>in_domain_list</code> type for now. <code>rules</code> will specify when match policy matched, this query should be forwarded to which <code>upstream</code>.</p><p><a href=https://github.com/Xuanwo/atomdns>atomdns</a>&lsquo;s config is powered by <a href=https://github.com/hashicorp/hcl/tree/hcl2>hcl2</a>:</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl>listen <span style=color:#666>=</span> <span style=color:#4070a0>&#34;127.0.0.1:53&#34;</span>

<span style=color:#007020;font-weight:700>upstream</span> <span style=color:#4070a0>&#34;oversea&#34;</span> {
  type <span style=color:#666>=</span> <span style=color:#4070a0>&#34;dot&#34;</span>
  addr <span style=color:#666>=</span> <span style=color:#4070a0>&#34;185.222.222.222:853&#34;</span>
  tls_server_name <span style=color:#666>=</span> <span style=color:#4070a0>&#34;public-dns-a.dns.sb&#34;</span>
}

<span style=color:#007020;font-weight:700>upstream</span> <span style=color:#4070a0>&#34;mainland&#34;</span> {
  type <span style=color:#666>=</span> <span style=color:#4070a0>&#34;udp&#34;</span>
  addr <span style=color:#666>=</span> <span style=color:#4070a0>&#34;114.114.114.114:53&#34;</span>
}

<span style=color:#007020;font-weight:700>match</span> <span style=color:#4070a0>&#34;to_mainland&#34;</span> {
  type <span style=color:#666>=</span> <span style=color:#4070a0>&#34;in_domain_list&#34;</span><span style=color:#60a0b0;font-style:italic>
</span><span style=color:#60a0b0;font-style:italic>  # get this file from https://github.com/felixonmars/dnsmasq-china-list
</span><span style=color:#60a0b0;font-style:italic></span>  path <span style=color:#666>=</span> <span style=color:#4070a0>&#34;/etc/atomdns/accelerated-domains.china.raw.txt&#34;</span>
}

rules <span style=color:#666>=</span> {
  <span style=color:#007020;font-weight:700>to_mainland</span><span>:</span> <span style=color:#4070a0>&#34;mainland&#34;</span>,
  <span style=color:#007020;font-weight:700>default</span><span>:</span> <span style=color:#4070a0>&#34;oversea&#34;</span>
}
</code></pre></div><p>We have two <code>upstream</code> here, and one names <code>oversea</code>, the other names <code>mainland</code>. When <code>to_mainland</code> matched which is in the domain list we specify here, we will forward it to <code>mainland</code>.</p><div class=highlight><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>atomdns[164688]: 2020/04/06 22:09:13 [{wx1.qq.com. 1 1}]
atomdns[164688]: 2020/04/06 22:09:13 rule to_mainland matched, served via mainland
atomdns[164688]: 2020/04/06 22:12:18 [{github.githubassets.com. 1 1}]
atomdns[164688]: 2020/04/06 22:12:18 no rules matched, served via oversea
</code></pre></div><p>Simple, but works.</p></div><div id=gitalk-container><div class=gt-container><div class=gt-meta><span class=gt-counts>0 comments</span></div><div class=gt-header><a class=gt-avatar-github><span class="gt-avatar gt-comment-avatar"><img src=https://www.gravatar.com/avatar/></span></a><div class=gt-header-comment><form class=gt-header-form target=comment-iframe method=post action=https://gitqus.now.sh/v0/comments/github.com/Xuanwo/xuanwo.github.io/master><input type=hidden name=slug value=/2020/04/05/my-solution-for-dns-poisoning-by-atomdns/>
<input class=gt-header-input type=text name=name placeholder=Name required>
<input class=gt-header-input type=email name=email placeholder=Email required>
<textarea class=gt-header-textarea name=content placeholder="Leave a comment"></textarea><div class=gt-header-controls><button class=gt-btn><span class=gt-btn-text>Submit</span></button></div><iframe name=comment-iframe hidden id=frame></iframe></form></div></div><div class=gt-comments></div></div></div></article></main><footer class="footer container"><a class=main-nav-link href=/categories/>Categories</a>
<a class=main-nav-link href=/tags/>Tags</a>
<a class=main-nav-link href=/series/>Series</a>
<a class=main-nav-link href=/blogroll/>Blogroll</a>
<a class=main-nav-link href=/index.xml>Subscribe</a>
<script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-51515330-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></footer></body></html>